---
title: "Untitled"
author: "Mishal Gudka"
date: "8 December 2022"
output: html_document
 ---

 pdf_document: default
  word_document: default
  
```{r setup, include=FALSE}

require(here)
library(tidyverse)
library(corrplot)
library(Hmisc)
library(dplyr)
library(vegan)
library(ggfortify)
library(readxl)
library(ggplot2)
library(tibble)
library(magrittr)
library(simpleboot)
library(forcats)
library(kableExtra)
library(knitr)
library(xtable)
library(pandoc)
library(flextable)
library(png)
library(grid)


knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = FALSE, fig.width=12, fig.height=8)
knitr::opts_knit$set(root.dir = here::here('Detailed evaluation/'))  #this sets the wd for the entire document
```

!## Importing data

```{r import}

data<-read.csv(file='review_detailed_eval_data.csv',header=T, stringsAsFactors = F)

```


## Excluding assessments

7 assessments did not meet inclusion criteria as resilience potential assessments

this is detailed in the file: ""

```{r exclude_assessments}

#exclude assessments:
#TS_2016_Eilat, AC_2019_Hawaii,	MW_2021_Chagos,	KH_2017_GBR,MG_2021_Palau, EHD_2017_PuertoRico, JM_2016_PNG

exclude<-Cs(TS_2016_Eilat, AC_2019_Hawaii,	MW_2021_Chagos,	KH_2017_GBR,MG_2021_Palau, EHD_2017_PuertoRico, JM_2016_PNG)

data<-data %>% 
  filter(!Study.ID.1 %in% exclude)

```


```{r cleaning_dataset, eval=TRUE}

#remove special characters throughout dataset
data$Title<- gsub('â', '', data$Title) #removes â
data$Title.1<- gsub('â', '', data$Title.1) #removes â
data$Which.resilience.factors.were.reported.quantified.<- gsub('â', '', data$Which.resilience.factors.were.reported.quantified.) #removes â
data$Which.indicators<- gsub('â', '', data$Which.indicators) #removes â

data$Title<- gsub('Â', '', data$Title) #removes â
data$Title.1<- gsub('Â', '', data$Title.1) #removes â
data$Which.resilience.factors.were.reported.quantified.<- gsub('Â', '', data$Which.resilience.factors.were.reported.quantified.) #removes â
data$Which.indicators<- gsub('Â', '', data$Which.indicators) #removes â

#removes €
data$Title<- gsub('€', '', data$Title) 
data$Title.1<- gsub('€', '', data$Title.1)
data$Which.resilience.factors.were.reported.quantified.<- gsub('€', '', data$Which.resilience.factors.were.reported.quantified.) 
data$Which.indicators<- gsub('€', '', data$Which.indicators) 
data$How.was.overall.resilience.level.classified.for.sites.<- gsub('€', '', data$How.was.overall.resilience.level.classified.for.sites.) 

#change the type - impacts analysis where filter out non-indicator-based analayses

data %<>%  mutate(What.type.of.resilience.potential.assessment.is.this. = case_when(
    Study.ID.1 == "AK_2013_Fiji" ~ "expert set of (normalised) resilience indicators",
    TRUE ~ What.type.of.resilience.potential.assessment.is.this.
  ))
```

##Regions
<!-- Southeast asia – Vietnam, Indonesia, Phillipines, Malaysia, Myanmar, Taiwan, Thailand – should be East Asia -->
<!-- Myanmar, Myeik Archipelago is towards the East Asia side -->
<!-- Indian Ocean – Maldives, India – South Asia (Myanmar also listed as S Asia) -->
<!-- Middle East – Saudi Arabia, Djibouti, Israel – Red Sea & Guld of Aden -->
<!-- Saudi Arabia – depends what side assessment done, Habitat Mapping and Characterization of Coral Reefs of the Saudia Arabian Red Sea, both are Saudi Red Sea -->
<!-- ROPME – only region not covered -->
<!-- Pacific – Kiribati, Hawaii, Palmyra, Micronesia, Palau, Fiji, Guam, American Samoa, PNG, CNMI – missing Guam and Palmyra from GCRMN list of Pacific, but are in Pacific -->
<!-- Atlantic - US Virgin Islands, USA, Haiti, Mexico - US Virgin Islands, USA, Haiti should be Caribbean -->
<!-- Caribbean - Puerto Rico, Bonaire, Cayman Islands, Ecuador, Belize – US Virgin Islands should be here -->
<!-- Ecuador is ETP -->

<!-- Changes to be made:  -->
<!-- US Virgin Islands, USA, Haiti, Mexico – all Atlantic to Carribeean -->
<!-- Ecuador to ETP -->
<!-- Middle East – Red Sea & Guld of Aden -->
<!-- Indian Ocean – South Asia  -->
<!-- Southeast asia – East Asia -->

```{r regions, eval=TRUE}

data$Region%>% unique()


 data %<>%
  # Replace other regions as desired
  mutate(Region = case_when(
    Region == "Atlantic" ~ "Caribbean",
    Country.Place == "Ecuador" ~ "ETP",
    Region == "Middle East" ~ "Red Sea & Gulf of Aden",
    Region == "Indian Ocean" ~ "South Asia",
    Region == "Southeast Asia" ~ "East Asia",
    Region == "Western Indian Ocean " ~ "WIO",
    TRUE ~ Region
  ))


#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(Region))) +
  geom_bar(aes(fill=Region))+
  theme_bw()+
  xlab('Region assessed')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


##Resilience Indicators
```{r resilience indicators, eval=TRUE}

#produce a unique set of resilience indicators
#ordered in alphabetical order

#need to split each and then create a long list 

#split by ;

#some entries, convert , to ;
#CL_2013_Mexico ; JM_2017_Florida; BS_2018_Samoa; MP_2015_Riung; EM_2012_Micronesia; JM_2019_Maui

#additional entries:  GG_2009_Pemba, RS_2017_Palau, MS_2019_Thailand, NE_2015_TalimBay, JK_2009_Kenya, RS_2016_Palmyra

commas<-Cs(CL_2013_Mexico , JM_2017_Florida, BS_2018_Samoa, MP_2015_Riung, EM_2012_Micronesia, JM_2019_Maui,  GG_2009_Pemba, RS_2017_Palau, MS_2019_Thailand, NE_2015_TalimBay, JK_2009_Kenya, RS_2016_Palmyra)

data %<>% 
  mutate(Which.indicators = case_when(Study.ID.1%in%commas~ gsub(",",";",Which.indicators),
                                      TRUE ~ Which.indicators))

#create a new object
indicators<-data$Which.indicators  %>% as.data.frame() %>% 
      rename('ind'='.')

#split by ;
indicators_split<-str_split_fixed(indicators$ind, ";",59) %>% as.data.frame() #nothing in cols 60 on, so can shorten to 59

#Change from wide to single, long column
data_long <- gather(indicators_split,study, values, V1:V59, factor_key=TRUE)

#cleaning steps: 1. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace
data_long$values<- gsub('^\\-|\\-$', '', data_long$values) #removes leading -
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<-tolower(data_long$values) #converts all captial to lower


#FINAL unqiue list 
indicators_list_final<-data_long$values %>% unique() %>% sort() %>% as.data.frame() 

#602 unique values including blank

#start standardising values or assigning them to each component

#probably both

#export list to manually assign clean names and resilience components
#indicators_list_final %>% write.csv("resilience_indicator_full_list_121222.csv")

t<-read.csv(file="resilience_indicator_full_list2.csv",header = TRUE, stringsAsFactors = F)

t1<-match(indicators_list_final$.,t$.,nomatch = 0)

t_list<-indicators_list_final$.[which(t1==0)] %>% as.data.frame()

t_list %>% write.csv("additional_indicators_for_master.csv")

#new metrics which are not in list that have added indicator groups to (after making changes to source)
#add these to the file 
# [1] "dominant size classes"         "estimates of hard corals"     
# [3] "estimates of soft corals"      "evidence of recover potential"
# [5] "largest corals)"               "median coral colony sizes" 

#now, new additions - 14/12/22

#  [1] "anthropogenic influences - overfishing"     
#  [2] "connectivity between sites"                 
#  [7] "herbivores (unknown)"                       
#  [8] "herbivorous fish abundance"                 
#  [9] "herbivorous fish functional group abundance"
# [12] "potential for upwelling"                    
# [13] "size class distributions"

#other changes would not show if they are already in list, and old can remain in list as wont match anymore anyway
```


```{r resilience_component_fishing , eval=TRUE}

#check that all fishing pressure as an indicator selected fish abundance
#already manually checked that all those that picked fish abundance/diversity had a relevant fish indicator

#fishing, fisher, human gravity

y<-grepl('fishing|fisher|human gravity',data$Which.indicators) %>% as.data.frame() %>% 
      rename('fish_press'='.')
y1<-grepl('Fish - abundance|Fish - diversity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_component'='.')

#match y and y1 - everytime y is TRUE, y1 should be TRUE as well

match(y$.,y1$.,nomatch = 0)

y2<-cbind(y,y1,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1')

#which fish_component is FALSE when fish_press is TRUE  

y2 %>% 
filter(fish_press==TRUE & fish_component==FALSE) %>% 
summarise(missing_fish_comp=Study.ID.1 %>% unique())

  #[1] "MG_2021_Palau"    "BM_2017_PalkBay"  "NE_2015_TalimBay"
  
  #MG_2021_Palau is fishing ground not pressure so exclude from list maybe (but this is a proxy of fish pressure so keep?)
  #the other two are fishing pressure so should be changed at source to include Fish-abundance
  
  #what else:
  # Fish - trophic balance (3 papers) - what indicators were used for this
  h<-grepl('Fish - trophic balance',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_component'='.') %>%
      cbind(data$Study.ID.1) %>%
      rename('Study.ID.1'='data$Study.ID.1') %>% 
      filter(fish_component==TRUE) %>% 
      summarise(Study.ID.1)
  
  #2015_Malaysia, JH_2013_Malaysia, AB_2011_SaudiArabia
  
  #branching residents, piscivores, obligate coral feeders (butterflyfish)
  #branching residents, piscivores, obligate coral feeders (butterflyfish)
  #obligate coral feeders (butterflyfish); branching residents, mollusc and crustacean abundance, omnivore biomass; detritivore biomass; planktivore biomass; carnivore biomass; invertivore biomass
  
  #they all have fish- abundance selected as well. I would remove fish-trophic balance for all for now
 
```


```{r assign_indicator_grps, eval=TRUE}

#Assign the indicator groups to the data
  
  # match the metrics to which.indicatorscolumn in data
  # if there is a match then assign the indicator group in a column

  indicator_group<-read_xlsx("resilience_indicator_full_list_latest_with_indicatorgrps.xlsx")
  
  indicator_group$`indicator group` %>% unique() %>% sort() #74 groups
  
  #format values in Which.indicators to match what was done to indicator list
data$Which.indicators<-sub("^\\s+", "", data$Which.indicators) #removesleading whitespace
data$Which.indicators<- sub("\\s+$", "", data$Which.indicators) #removes trailing whitespace
data$Which.indicators<- gsub('^\\-|\\-$', '', data$Which.indicators) #removes leading -
data$Which.indicators<-tolower(data$Which.indicators) #converts all captial to lower

#the issue with removing brackets and having exact matches, is that if there isn't a non-bracketed version it won't match
#e.g. coral colour (3 indicators) will need a coral colour metric in the list to match, which in this case it does have
#need to manually check this to anticipate any issues

  for (i in 1:nrow(indicator_group)){
  x=indicator_group$metrics[i]
  #x=gsub("\\s*\\([^\\)]+\\)","",x) 
  brackets=grepl("([()])",x) #check if x has brackets
  #if there are brackets in x:
  if (brackets==TRUE){
  o<-grepl(x,data$Which.indicators, fixed=TRUE,ignore.case=TRUE)
  }
  else{ #if no brackets in x
  o<-grepl(paste0("\\b",x,"\\b"),data$Which.indicators) #looks for exact matches - works for the sediment issue but can't have () in x
  }
  v<-indicator_group$`indicator group`[i]
  for (j in 1:nrow(data)){
    #IF THE COLUMN DOES NOT EXIST FOLLOW THIS LOOP TO CREATE COLUMN
    if (v%in%colnames(data)==FALSE){ #COLUMN DOESNT EXIST IN DATA
      data[v]<-0  #CREATE COLUMN
  if (o[j]==TRUE){ 
    data[j,v] <- 1
  }}else  if (v%in%colnames(data)==TRUE){#column exists
  if (o[j]==TRUE){ 
    data[j,v] <- 1
  } else if(o[j]==FALSE & data[j,v]==1){} #if it already has a 1, don't overwrite
    #else {data[j,v]<-0}
      }}}
  
  #if the same column v is found later, the row value can be overwritten with a 0 even if it was 1 with a previous indicator
  #don't think grepl handles ( ) very well so included fixed=TURE
  
  #need to validate that it worked - manually check a few assessments
  
#create a summary table which shows the number of times/assessments each resilience indicator was used
start_col <- "bleaching resistance of coral community"
end_col <- "plankton abundance"
cols_to_exclude <- c("chung", "exclude")

col_indices <- which(colnames(data) %in% c(start_col, end_col))
cols_of_interest <- colnames(data)[col_indices[1]:col_indices[2]]
cols_of_interest <- cols_of_interest[!(cols_of_interest %in% cols_to_exclude)]

#must exclude 5 assessments with incomplete indicator lists before summarising
exclude_component<-Cs(DM_2016_EastAfrica, RS_2017_Maldives,DO_2008_Amirantes, GS_2009_PhoenixIsl,NE_2015_TalimBay)

summary_table <- data %>%
  filter(!Study.ID.1 %in% exclude_component) %>%
  select(cols_of_interest) %>% 
  summarise_all(sum) %>% 
  gather(indicator, n_assessments) %>% 
  arrange(desc(n_assessments))%>% 
  filter(n_assessments != 0)

#cloud cover, herbivore-general and wind all have sum of zero - they were not found in the list of indicators
#why were they created as new columns?
#assessments with wind and cloud cover are not part of the 68, and herbivore-general is produced by matching the term 'herbivorous fish populations' which is not found in data anymore
#these columns are being created as the code goes through each row in indicator_group and creates a column with the indicator_group column if it doesn't exist - this creates 78 new cols which is the number of unique indicator_groups. This step is not dependent on if the metric from indicator group is found in the which indicators column
#easiest is to just delete those with sum=0 from the summary table



```

```{r ind_kable, results='asis'}

kable(summary_table, caption = "Summary table for coral community data", 
      row.names = FALSE) %>% 
  kable_styling(full_width = F)


```

```{r ind_kableextra, results='asis', eval=FALSE, include=FALSE}
library(kableExtra)

summary_table %>%
  kable(format = "markdown", booktabs = T, caption = "Summary Table") %>%
  kable_styling(bootstrap_options = c("striped", "hover"), full_width = F)

```

```{r ind_pander, results='asis', eval=FALSE, include=FALSE}
library(pander)

pander(summary_table, caption = "Summary Table")



```

```{r ind_gt , results='asis', eval=FALSE, include=FALSE}
library(gt)

summary_table %>% 
  gt()

print(gt)

```





```{r res_component_connect , eval=TRUE}
# Environment - connectivity - check it was ticked for all connectivity indicators
  
  #when Connectivity - other reefs or Connectivity - associated ecosystems is 1, then Environment - connectivity should be selected
  
ycon<-grepl('Environment - connectivity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('connectivity'='.')

ycon2<-cbind(ycon,data$`connectivity - associated ecosystems`,data$`connectivity - other reefs`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','other_reefs'='data$`connectivity - other reefs`','other_eco'='data$`connectivity - associated ecosystems`')

ycon2 %<>% 
   mutate(any_connectivity = rowSums(across(where(is.numeric))))

#which connectivity COMPONENT is FALSE when connectivity indicators are listed  
ycon2 %>% 
filter(connectivity==FALSE & any_connectivity!=0) %>% 
summarise(missing_connectivity=Study.ID.1 %>% unique()) #None - no issue

#any times connectivity component was selected with no connectivity indicators listed
ycon2 %>% 
filter(connectivity==TRUE & any_connectivity==0) %>% 
summarise(false_connectivity=Study.ID.1 %>% unique())
#5
# JK_2009_Kenya	- is in factors but not indicators - check			
# DO_2008_Amirantes	- factors listed but not indicators - components selected based on factors, so is ok in this case
# GS_2009_PhoenixIsl - some factors listed but indicators unknown - components selected based on factors, so is ok in this case		
# YMB_2022_GBR  - 				model
# IF_2022_Sulawesi - connectivity should not be selected but check what indicator good juvenile coral supply applies to


#OTHER BIODIVERSITY
  # Other biodiversity - diversity - 1 paper (CL_2013_Mexico) - check this and other indicators used to see if overlooked this at all
#most likely invasive species abundance indicator that made me select this -de-select other BD component @ source

#CORAL RECRUITMENT/REPRODUCTION

  #find all those where Coral - reproduction were chosen but there is no associated resilience indicator
yrep<-grepl('Coral - reproduction',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('repro_comp'='.')

yrep2<-cbind(yrep,data$`coral recruitment`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_recruitment'='data$`coral recruitment`')

#which reproduction COMPONENT is FALSE when recruitment indicators are listed  
#None
yrep2 %>% 
filter(repro_comp==FALSE & coral_recruitment!=0) %>% 
summarise(missing_reproduction=Study.ID.1 %>% unique())

#any times reproduction component was selected with no recruitment indicators listed
yrep2 %>% 
filter(repro_comp==TRUE & coral_recruitment==0) %>% 
summarise(false_reproduction=Study.ID.1 %>% unique())

#5 assessments
# JK_2009_Kenya			- recheck this assessments indicator selection (issue with connectivity also)	
# DO_2008_Amirantes	- indicators not detailed but factors and components are
# YMB_2022_GBR			
# DO_2009_NosyHara	- not in factors or indicators - genuine error, reproduction component should not be selected - CHANGE IN SOURCE			
# PM_2014_Caribbean - model so indicators not listed

```



```{r res_component_habitat , eval=TRUE}

#can also check to make sure Habitat is selected when any substrate indicator is used
yhab<-grepl('Habitat - complexity and composition',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('habitat_comp'='.')

yhab2<-cbind(yhab,data$`suitable substrate`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','suitable_subs'='data$`suitable substrate`')

#which habitat COMPONENT is not selected when suitable substrate indicators are listed  

yhab2 %>% 
filter(habitat_comp==FALSE & suitable_subs!=0) %>% 
summarise(missing_habitat=Study.ID.1 %>% unique())

#3 assessments - after manual check none of these have any suitable substrate indicators, so my loop is erronously assigning the suitable substrate group to these 3 assessments, most likely because they all have sediment in the Which.indicators column, and this is assigned to suitable substrate in the indicator group list
#THIS HAS BEEN RESOLVED AND SO NOW GET 0 ASSESSMENTS


yhab2<-cbind(yhab2,data$`structural complexity`,data$`physical impacts`) %>% rename('structural_complexity'='data$`structural complexity`','physical_impacts'='data$`physical impacts`')

#any errors where Habitat component is not selected but structural complexity indicators are selected
yhab2 %>% 
filter(habitat_comp==FALSE & structural_complexity!=0) %>% 
summarise(missing_habitat=Study.ID.1 %>% unique())

#2 assessments - RS_2011_Palau,RS_2011_Wakatobi - check these

yhab2 %<>% 
   mutate(any_habitat = suitable_subs+structural_complexity)

#check if everytime habitat COMPONENT is selected either suitable substrate and structural complexity is selected
yhab2 %>% 
filter(habitat_comp==TRUE & any_habitat==0) %>% 
summarise(false_habitat=Study.ID.1 %>% unique() %>% sort())

#10 assessments to check
# AK_2013_Fiji				- cover of live coral and crustose coralline algae - unselect habitat @ source - NO, keep
# Bang_2021_Taiwan		- typhoon exposure, physical human impact, tourism - all ok
# BR_2019_Ecuador			- coral framework development created issue - unselect habitat @ source
# DO_2008_Amirantes		- no indicators		
# GS_2009_PhoenixIsl	- no indicators
# JH_2017_Indonesia		- CCA cover most likely is reason I picked Habitat - think about whether CCA should be included as factor 4 habitat - Yes, so no change required	
# MG_2021_Palau			  - typhoons created issue - think about whether typhoons should be included as factor for habitat- Yes, no change needed
# SA_2011_Indonesia		- no indicators		
# TM_2012_ KarimunjawaIslands		- 	physical human impacts is reason - ok	
# YMB_2022_GBR        - no indicators


#Check if Habitat component is selected when physical damage indicator is selected and no other substrate or structural complexity indicators

yhab2 %>% 
filter(habitat_comp==FALSE & physical_impacts!=0) %>% 
summarise(missing_habitat=Study.ID.1 %>% unique())

#3 times - habitat component not selected but physical damage indicator is selected - Check and correct at source
#PIFSC_2014_Hawaii				
# BS_2018_Samoa				
# RA_2014_India
#Change in source - select Habitat component @ source

#Check if respective components are selected each time a relevant indicator is selected
#CCA -> Habitat
yhab2<-cbind(yhab2,data$CCA) %>% rename('CCA'='data$CCA')

#ALL assessments with CCA should have habitat_comp=TRUE, so check those where habitat_comp=FALSE
yhab2 %>% 
filter(habitat_comp==FALSE & CCA!=0) %>% 
summarise(missing_habitat=Study.ID.1 %>% unique())
#None - no issues
#There are some assessments which have habitat=TRUE but CCA=0 as most likely habitat=TRUE is from another indicator group

#Cyclones -> Habitat
yhab2<-cbind(yhab2,data$`cyclones/storms`) %>% rename('cyclone'='data$`cyclones/storms`')

yhab2 %>% 
filter(habitat_comp==FALSE & cyclone!=0) %>% 
summarise(missing_habitat=Study.ID.1 %>% unique() %>% sort())
#none - no issues
```


```{r res_component_variable, eval=TRUE}

# branching residents – where do these fall under? Fish, other BD? 
# Coral associates – check with components selected to make sure other BD is selected when this is an indicator
# coastal development – other?
# coral exposure at low tide – coral (thermal tolerance) or environment?


# branching residents
#can also check to make sure Habitat is selected when any substrate indicator is used
yfishd<-grepl('Fish - diversity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_div'='.')

yfishd2<-cbind(yfishd,data$`branching residents`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','branching_residents'='data$`branching residents`')

#which Fish - diversity COMPONENT is not selected when branching resident indicators are listed  

yfishd2 %>% 
filter(fish_div==FALSE & branching_residents!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #10 assessments


yfisha<-grepl('Fish - abundance',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_abund'='.')

yfisha2<-cbind(yfisha,data$`branching residents`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','branching_residents'='data$`branching residents`')

#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

yfisha2 %>% 
filter(fish_abund==FALSE & branching_residents!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #0 assessments - all matched



yotherbd<-grepl('Other biodiversity - diversity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('other_bd'='.')

yotherbd2<-cbind(yotherbd,data$`branching residents`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','branching_residents'='data$`branching residents`')

#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

yotherbd2 %>% 
filter(other_bd==FALSE & branching_residents!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #10 assessments

#Coral associates
#can also check to make sure Habitat is selected when any substrate indicator is used
y<-grepl('Fish - abundance',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_abund'='.')

y2<-cbind(y,data$`coral associates`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_associates'='data$`coral associates`')

#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

y2 %>% 
filter(fish_abund==FALSE & coral_associates!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #1 assessment -GS_2009_PhoenixIsl

#fish-diversity
y<-grepl('Fish - diversity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('fish_div'='.')

y2<-cbind(y,data$`coral associates`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_associates'='data$`coral associates`')

#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

y2 %>% 
filter(fish_div==FALSE & coral_associates!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #2 assessments 



yotherbd<-grepl('Other biodiversity - diversity',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('other_bd'='.')

yotherbd2<-cbind(yotherbd,data$`coral associates`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_associates'='data$`coral associates`')


#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

yotherbd2 %>% 
filter(other_bd==FALSE & coral_associates!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #2 assessments (100% of assessments)



y<-grepl('Corallivores/bioeroders',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('coral_bio'='.')

y2<-cbind(y,data$`coral associates`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_associates'='data$`coral associates`')


#which Fish - abundance COMPONENT is not selected when branching resident indicators are listed  

y2 %>% 
filter(coral_bio==FALSE & coral_associates!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #2 assessments (100% of assessments)


# coastal development


y<-grepl('Environment - water quality',data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('coastal'='.')

y2<-cbind(y,data$`coastal development`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coastal_dev'='data$`coastal development`')


#which Environment - water quality COMPONENT is not selected when coastal development indicators are listed  

y2 %>% 
filter(coastal==FALSE & coastal_dev!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #0 assessments 



# coral exposure at low tide – coral (thermal tolerance) or environment?
comp<-"Habitat - complexity and composition" 
comp<-"Coral - thermal tolerance"
comp<-"Environment - thermal profile"

y<-grepl(comp,data$Which.resilience.components.were.reported.quantified.) %>% as.data.frame() %>% 
      rename('component'='.')

y2<-cbind(y,data$`coral exposure`,data$Study.ID.1) %>% rename('Study.ID.1'='data$Study.ID.1','coral_exposure'='data$`coral exposure`')


#which COMPONENT is not selected when coral exposure indicators are listed  

y2 %>% 
filter(component==FALSE & coral_exposure!=0) %>% 
summarise(missing_component=Study.ID.1 %>% unique()) #0 assessments 

#ALL COMPONENTS HAD zero assessments - matched with all
#could be habitat, thermal profile or thermal tolerance. will go for environment

```

Next steps
"BM_2017_PalkBay"  "NE_2015_TalimBay"
    #the other two are fishing pressure so should be changed at source to include Fish-abundance

2015_Malaysia, JH_2013_Malaysia, AB_2011_SaudiArabia
 # remove fish-trophic balance for all for now

anytimes connectivity component was selected with no connectivity indicators listed
JK_2009_Kenya	- is in factors but not indicators - check			
IF_2022_Sulawesi - connectivity should not be selected but check what indicator good juvenile coral supply applies to

Other BD - 1 paper (CL_2013_Mexico) - #most likely invasive species abundance indicator that made me select this -de-select other BD component @ source

CORAL RECRUITMENT/REPRODUCTION
any times reproduction component was selected with no recruitment indicators listed
JK_2009_Kenya - recheck this assessments indicator selection (issue with connectivity also)	
DO_2009_NosyHara	- not in factors or indicators - genuine error, reproduction component should not be selected - CHANGE IN SOURCE			

any errors where Habitat component is not selected but structural complexity indicators are selected
2 assessments - RS_2011_Palau,RS_2011_Wakatobi - check these

3 times - habitat component not selected but physical damage indicator is selected - Check and correct at source
PIFSC_2014_Hawaii				
BS_2018_Samoa				
RA_2014_India
Change in source - select Habitat component @ source

BR_2019_Ecuador - coral framework development created issue - unselect habitat @ source

Check those assessments with no indicators but factors/components listed (selected)
DO_2008_Amirantes	- no indicators		
GS_2009_PhoenixIsl	- no indicators
YMB_2022_GBR        - no indicators
SA_2011_Indonesia	- no indicators	
PM_2014_Caribbean - model so indicators not listed

##Resilience components

```{r res_component_frequency, eval=TRUE}

# - bar plot showing frequency of responses
data$Which.resilience.components.were.reported.quantified.%>% unique()

#there are 2 blanks - DM_2016_EastAfrica, RS_2017_Maldives
#DM_2016_EastAfrica - don't know the indicators/factors - keep blank
#RS_2017_Maldives - no indicator or factor details - keep blank

# DO_2008_Amirantes
# GS_2009_PhoenixIsl
# NE_2015_TalimBay
#resilience indicator information is missing/incomplete from these 3 assessments, and so listing of resilience components cannot be exhaustive

#For those where we did not know the specific indicators, can either:
#a. use the factors listed
#b. work using selected resilience components 
#c. was there any evidence of gaps in key resilience components/factors? if listed as 'unclear' means did not have enough/complete information on resilience indicators to fully complete all resilience components 

#since we are thinking about the percentage of assessments a particular component was represented, should we exclude all assessments which were incomplete? 

#can filter these using Was there any evidence of gaps in key resilience components/factors? (new) = 'unclear', as all 5 assessments are the only ones with this response

#Missing Resilience components
#In total 4 assessments measured Other biodiversity component
#should add other biodiversity to these two assessments as they had invert abundance/density indicators: AB_2011_SaudiArabia and LR_2014_Micronesia
#AB_2011_SaudiArabia - mollusc and crustacean abundance; #LR_2014_Micronesia - invert density
#This has not been corrected in the script or data!! So not reflected in the graphs but is reflected in manuscript text


exclude_component<-Cs(DM_2016_EastAfrica, RS_2017_Maldives,DO_2008_Amirantes, GS_2009_PhoenixIsl,NE_2015_TalimBay)

data %>%
  filter(Study.ID.1 %in% exclude_component) %>%
  pull(Was.there.any.evidence.of.gaps.in.key.resilience.components.factors...new.)
# [1] "unclear" "unclear" "unclear" "unclear" "unclear"

#Create a seperate dataset
res_comp<-data %>% 
            filter(!Study.ID.1 %in% exclude_component) %>% 
              mutate(components2=`Which.resilience.components.were.reported.quantified.`) %>% 
                select(Study.ID.1,components2) 

#Steps to get the frequency occurence of responses:
#need to create a unique list of responses
#first seperate responses into different columns
#rbind the columns into a single column/vector
#peform unique function on this
#recode the factors where necessary 
#perform unique to get final list

#split by ; into individual columns

str_split_fixed(res_comp$components2, ";",15) #nothing in cols 15, so can shorten to 14

res_comp_split<-str_split_fixed(res_comp$components2, ";", 14)  %>% as.data.frame()
res_comp_split$study<-res_comp$Study.ID.1

#Change from wide to single, long column
data_long <- gather(res_comp_split,study, values, V1:V14, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace

#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence


#CREATE NEW FACTOR GROUPINGS
data_long %<>%
  mutate(values=values  %>% factor() %>%
                fct_recode(`Corallivores/bioeroders` = "Corallivores/bioeroders -  abundance (outbreaks), biological controls (abundance/presence)",
                           `Habitat - availability and quality`="Habitat - complexity and composition",
                           `Herbivory`="Competitors - biological controls",
                           `Competitors - competition level`="Competitors - competition level (interactions)",
                           `Coral - demography`="Coral - growth,age"))

#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%    #remove the NAs
  count(values)  #frequency count of responses

#calculate percentage occurences 
data_plot$percent<-(data_plot$n/nrow(res_comp)*100) %>% round(1)


data_plot <- data_plot %>% 
   mutate(ecosystem_component = fct_recode(values,
    "Competitors" = "Competitors - abundance",
    "Competitors" = "Herbivory",
    "Competitors" = "Competitors - competition level",
    "Coral" = "Coral - abundance",
    "Coral" = "Coral - condition",
    "Coral" = "Coral - diversity",
    "Coral" = "Coral - demography",
    "Coral" = "Coral - reproduction",
    "Coral" = "Coral - thermal tolerance",
    "Corallivores/bioeroders" = "Corallivores/bioeroders",
    "Environment" = "Environment - connectivity",
    "Environment" = "Environment - thermal profile",
    "Environment" = "Environment - water quality, nutrients",
    "Fish" = "Fish - abundance",
    "Fish" = "Fish - diversity",
    "Habitat" = "Habitat - availability and quality",
    "Other biodiversity" = "Other biodiversity - diversity"
  ))
#In this code, we first load the dplyr and tidyr packages, then use the mutate function from dplyr to create a new column ecosystem_component by using the case_when function from tidyr to assign each level in the values column to an ecosystem component based on the text before the -. If a level in the values column doesn't match any of the specified cases, it will be assigned NA.

#creates a new label for resilience components without ecosystem component in name
data_plot %<>%
  mutate(label = case_when(
    str_detect(values, "-") ~ str_trim(str_split_fixed(values, "-", 2)[, 2]),
    TRUE ~ str_trim(values)
  ))


#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total

data_plot <- data_plot %>%
  arrange(ecosystem_component, desc(percent)) %>%
  mutate(label = factor(label, levels = unique(label))) 

ggplot(data_plot, aes(x = label, y = percent,fill = ecosystem_component)) +
  geom_bar(stat = "identity") +
  facet_grid(ecosystem_component ~ ., scales = "free", space = "free", switch = "y")+
  theme_bw() +
  xlab('') +
  ylab('Percentage of assessments') +
  coord_flip() +
  theme(legend.position = 'none') +
  theme(axis.text.x = element_text()) +
  theme(panel.border = element_blank(),
        axis.text = element_text(size = 15),
        axis.line = element_line(colour = "black"),
        text = element_text(size = 15),
        strip.background = element_blank(),
        strip.text = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),  # remove major grid lines
        panel.grid.minor = element_blank())



```


need a measure of how many assessments had each ecosystem component represented
can get that from resilience component information

```{r res_ind_eco_comp_plot, eval=TRUE}
#create a figure which shows the 3 most common indicator_groups per ecosystem_component
#plot of the number of assessments
#essentially a inverted bar plot grouping by ecosystem_component
#Using indicator_group object read in earlier

#use summary_table created above and add ecosystem_component to each group

summary_table$ecosystem_component<-indicator_group$`ecosystem component`[match(summary_table$indicator,indicator_group$`indicator group`)]


# summarize data frame by selecting the top 5 indicators based on n_assessments
#add steps that will rename values of ecosystem_component 'herbivory' and 'Corallivores/bioeroders' to 'competitors' and 'other' respectively and will exclude indicator values 'unknown' and 'missing'.

top_indicators <- summary_table %>%
  mutate(ecosystem_component = ifelse(ecosystem_component == "herbivory", "competitors", ecosystem_component)) %>%
  mutate(ecosystem_component = ifelse(ecosystem_component == "Corallivores/bioeroders", "other", ecosystem_component)) %>%  
  mutate(ecosystem_component = ifelse(ecosystem_component == "habitat", "structure", ecosystem_component)) %>%
  mutate(ecosystem_component = ifelse(ecosystem_component == "environment", "abiotic", ecosystem_component)) %>% 
  filter(indicator != "unknown" & indicator != "missing") %>%
  group_by(ecosystem_component) %>%
  arrange(desc(n_assessments)) %>%
  mutate(p_assessments=(n_assessments/63)*100) %>% #percentage of assessments
  slice_head(n = 4) %>%
  ungroup()

#rename branching residents 
top_indicators$indicator[top_indicators$indicator=='branching residents']<-'branching coral residents'

#rename ecosystem component other to complementary 
top_indicators$ecosystem_component[top_indicators$ecosystem_component=='other']<-'complementary'

order_plot<-Cs(coral, competitors, fish,  abiotic, structure,complementary)

top_indicators$ecosystem_component %<>% factor(levels=order_plot)


#How often was each ecosystem component represented
#uses the data_long from previous chunk 'res_component_frequency' which is based on 63 assessments (5 incompletes excluded)
data_long$study<-res_comp_split$study

data_long_comps <- data_long %>% 
  mutate(ecosystem_component = fct_recode(values,
                                          "competitors" = "Competitors - abundance",
                                          "competitors" = "Herbivory",
                                          "competitors" = "Competitors - competition level",
                                          "coral" = "Coral - abundance",
                                          "coral" = "Coral - condition",
                                          "coral" = "Coral - diversity",
                                          "coral" = "Coral - demography",
                                          "coral" = "Coral - reproduction",
                                          "coral" = "Coral - thermal tolerance",
                                          "other" = "Corallivores/bioeroders",
                                          "abiotic" = "Environment - connectivity",
                                          "abiotic" = "Environment - thermal profile",
                                          "abiotic" = "Environment - water quality, nutrients",
                                          "fish" = "Fish - abundance",
                                          "fish" = "Fish - diversity",
                                          "structure" = "Habitat - availability and quality",
                                          "other" = "Other biodiversity - diversity"
  ))

data_long_comps2<-data_long_comps %>% 
                   mutate_all(na_if,"") %>%  #make blanks into NAs
                     na.omit() %>%
                        group_by(ecosystem_component) %>% 
                        summarise(n=study %>% unique() %>% length(),
                                  per = n/(unique(data_long_comps$study) %>% length())*100 %>% round(1)) #percentage of assessmnets

#rename ecosystem component other to complementary 

data_long_comps2 <- data_long_comps2 %>% 
  mutate(ecosystem_component = fct_recode(ecosystem_component,
                                          "complementary" = "other"))

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
# ggplot(top_indicators, aes(x= indicator, y=n_assessments)) +
  # geom_bar(stat = "identity",  aes(fill = ecosystem_component, group = ecosystem_component, order=factor(ecosystem_component, levels = order_plot))) +

#colour blind friendly palette
cbp1 <- c("#E69F00","#F0E442", "#009E73", "#56B4E9","#0072B2", "#CC79A7")

p<-ggplot(top_indicators, aes(x=fct_reorder(indicator,p_assessments, .fun = mean), y=p_assessments, fill=ecosystem_component, order=ecosystem_component))+
   geom_rect(data = data_long_comps2, aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = per,fill = ecosystem_component), alpha = 0.2, inherit.aes = FALSE) +
  geom_bar(stat = "identity") +
  facet_grid(ecosystem_component ~ ., scales = "free", space = "free", switch = "y")+
  theme_bw()+
  xlab('')+
  ylab('Percentage of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text(size=16))+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=16),
        axis.line = element_line(colour = "black"),
        text = element_text(size=16),
        strip.background = element_blank(),
        strip.text = element_text(size = 15.8, face = "bold"),
        panel.grid.major = element_blank(),  # remove major grid lines
        panel.grid.minor = element_blank())+
  scale_fill_manual(values = cbp1)

#import images to add to plot
coral = readPNG("icons/coral_laminar.png") 
competitors = readPNG("icons/fleshy_algae.png")
fish = readPNG("icons/grouper_final.png")
env = readPNG("icons/thermometer_final.png")
habitat = readPNG("icons/structure.png")
other = readPNG("icons/COTs_final.png")


annotation_custom2 <- 
function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data){ layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))}

a1 = annotation_custom2(rasterGrob(coral,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100, data=top_indicators[9,])
a2 = annotation_custom2(rasterGrob(competitors,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100, data=top_indicators[5,])
a3 = annotation_custom2(rasterGrob(fish,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100, data=top_indicators[13,])
a4 = annotation_custom2(rasterGrob(env,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100, data=top_indicators[1,])
a5 = annotation_custom2(rasterGrob(habitat,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100, data=top_indicators[21,])
a6 = annotation_custom2(rasterGrob(other,width = unit(0.75, "in"), height = unit(0.75, "in"), interpolate=TRUE), xmin=2, xmax=4, ymin=85, ymax=100,data=top_indicators[17,])

ph<- p + a1 + a2+ a3+ a4+ a5+ a6

ggsave("indicators_ecosystem_components.jpg", plot = ph, width = 15.92, height = 10.61, dpi = 450)

```

The figure is out of 63 assessments for which I have complete information on the resilience indicators used 
For those where we did not know the specific indicators:was there any evidence of gaps in key resilience components/factors? if listed as 'unclear' 

```{r indicator_comp_table, eval=TRUE}

#add the ecosystem component to each indicator before producing table
sum2<-summary_table %>%
       mutate(ecosystem_component = ifelse(ecosystem_component == "herbivory", "competitors", ecosystem_component)) %>%
       mutate(ecosystem_component = ifelse(ecosystem_component == "corallivores/bioeroders", "Corallivores/bioeroders", ecosystem_component)) %>%
       mutate(ecosystem_component = ifelse(ecosystem_component == "habitat", "habitat/structure", ecosystem_component)) %>%
       mutate(ecosystem_component = ifelse(ecosystem_component == "environment", "abiotic environment", ecosystem_component)) %>% 
       mutate(ecosystem_component = ifelse(indicator == "invasives", "invasives", ecosystem_component)) %>% 
       mutate(ecosystem_component = ifelse(indicator == "invert abundance", "other biodiversity", ecosystem_component)) %>% 
       mutate(ecosystem_component = ifelse(indicator == "lobster", "other biodiversity", ecosystem_component)) %>% 
       mutate(ecosystem_component = ifelse(indicator == "plankton abundance", "other biodiversity", ecosystem_component)) %>% 
        mutate(ecosystem_component = ifelse(ecosystem_component == "other", "pressures", ecosystem_component)) %>% 
         filter(indicator != "unknown" & indicator != "missing") %>%
       arrange(desc(n_assessments)) %>%
       arrange(ecosystem_component)

#need to change ecosystem component for the Other to correct one - could make changes manually in word table

#re-order table based on eco components as follows: coral, competitors, fish, abiotic, other b, corallivores, habitat

#make factor
unique(sum2$ecosystem_component)
# [1] ""                        "abiotic environment"     "competitors"             "coral"                   "Corallivores/bioeroders"
# [6] "fish"                    "habitat/structure"       "invasives"               "other"                   "Other biodiversity"

comp_order<-c("coral", "competitors", "fish", "Corallivores/bioeroders","invasives", "Other biodiversity" ,"abiotic environment", 
                                 "habitat/structure","pressures")
#re-order by component
sum2 %<>% arrange(factor(ecosystem_component, levels = comp_order))

```

```{r ind_comp_kable, results='asis'}

kable(sum2, caption = "Summary table for coral community data", 
      row.names = FALSE) %>% 
  kable_styling(full_width = F)


```

	
##Were there any gaps in resilience components  

```{r res_component_gaps, eval=TRUE}

# - bar plot showing frequency of responses
data$Was.there.any.evidence.of.gaps.in.key.resilience.components.factors...new.%>% unique()
# [1] "2 essential components missing"  "1 essential component missing"   "some non-essential gaps"        
# [4] "unclear"                         ">2 essential components missing" "effectively covered"

factor_order<-c(">2 essential components missing","2 essential components missing","1 essential component missing","some non-essential gaps","effectively covered","unclear")

data %<>%  mutate(`component_gaps`=`Was.there.any.evidence.of.gaps.in.key.resilience.components.factors...new.`  %>% factor(levels = factor_order) %>%
                                 fct_recode(`>2 essential` = ">2 essential components missing",
                                            `2 essential`= "2 essential components missing",
                                           `1 essential`="1 essential component missing",
                                           `some non-essential`="some non-essential gaps",
                                           `effectively covered`="effectively covered",
                                          unclear ="unclear")) 


#major ecosystem components
data$major <- "NA"
for (i in 1:nrow(data)) {
  major_components <- c("Coral", "Fish", "Competitors", "Environment", "Habitat")
  res_components <- strsplit(as.character(data[i, "Which.resilience.components.were.reported.quantified."]), ";")[[1]]
  missing_components <- c()
  
  if (length(grep("\\bCoral\\b", res_components)) < 3) { #coral doesn't work if with corralivores - add //b

    missing_components <- c(missing_components, "Coral")
  }
  if (length(grep("Fish", res_components)) == 0) {
    missing_components <- c(missing_components, "Fish")
  }
  if (length(grep("Competitors", res_components)) < 2) {
    missing_components <- c(missing_components, "Competitors")
  }
  if (length(grep("Environment", res_components)) == 0) {
    missing_components <- c(missing_components, "Environment")
  }
  if (length(grep("Habitat", res_components)) == 0) {
    missing_components <- c(missing_components, "Habitat")
  }
  
  data[i, "major"] <- paste(missing_components, collapse = ";")
}

#SOME OF THE component_gaps VALUES ARE NOT APPEARING - SOME NON-ESSENTIAL AND EFFECTIVELY COVERED since there are no major gaps
#non-essential and effectively covered, could add a 'component_gaps'=none or no gaps or other, and majors 'non-essential' and 'effectively covered'
#WHAT ABOUT unclear? should not have any ecosystem_components listed - in data need to add a step that for all Unclear, make major blank - add this to the loop

#Here, we use nested if_else() functions. The first if_else() replaces the values in the major column with blank if the corresponding value in the component_gaps column is 'unclear', and replaces any blank values in the major column with the corresponding value from the component_gaps column. The second if_else() replaces any values in the component_gaps column that are 'unclear', 'some non-essential', or 'effectively covered' with 'other'.

# Step 1: if component_gaps is 'unclear', major should be blank
data %<>% 
  mutate(major = if_else(component_gaps == 'unclear', '', major))

# Step 2: if major is blank, replace with the value of component_gaps
data %<>% 
  mutate(major = if_else(major == '', as.character(component_gaps), major))

# Step 3: replace values of 'unclear', 'some non-essential', 'effectively covered' with 'other' in component_gaps
data %<>% 
  mutate(component_gaps = if_else(component_gaps %in% c('unclear', 'some non-essential', 'effectively covered'), 'Other', as.character(component_gaps))) %>% 
  mutate(major = str_to_title(major),
         major = str_replace(major, "Some Non-Essential", "Non-Essential"))


df_split <- data %>% 
  unnest(major = strsplit(major, ";"))

# create a frequency table of component_gaps and major
df_table <- df_split %>% 
  count(component_gaps, major)

df_component_gaps <- data %>%
  group_by(component_gaps) %>% 
  count(component_gaps)

df_table$total_count<-df_component_gaps$n[match(df_table$component_gaps,df_component_gaps$component_gaps)]


# calculate the proportion of each value of major for each component_gaps
df_table %<>% mutate(proportion=n/total_count %>% round(2))

#this table has the plotting values. but the sum of the proportion is > 100% so can't do traditional staked plot.
#can try to split each bar horizontally rather than vertically - each bar split to show the 
#could plot within each bar just the ecosystem component with the highest contribution to the gap

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total

ggplot(data, aes(x= factor(component_gaps))) +
  geom_bar(aes(fill=component_gaps))+
  theme_bw()+
  scale_fill_manual(values = c("firebrick1", "firebrick1", "firebrick1", "dodgerblue1", "green3", "purple3"))+
  xlab('Number of missing resilience components')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


#plot 2

factor_order2<-c(">2 essential","2 essential","1 essential","Other")

df_table %<>%  mutate(component_gaps= component_gaps %>% factor(levels = factor_order2))

ggplot(df_table,aes(x = component_gaps, y = n, fill = major)) +
        geom_rect(data = df_table, aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = total_count),fill = 'grey', alpha = 0.1, inherit.aes = FALSE) +
    geom_bar(position = "dodge", stat="identity") +
    # geom_errorbar(aes(ymin = total_count, ymax = total_count), width = 0.85, size = 1, color = "black", linetype='dashed') +
    facet_grid(component_gaps ~ ., scales = "free", space = "free", switch = "y") +
    labs(title = "Missing ecosystem components",
       x = "Number of missing ecosystem components",
       y = "Number of assessments",
       fill = "Ecosystem component") +
    coord_flip() +
  theme_minimal() +
  theme(
        panel.grid.major.x = element_blank(),
        axis.text.y = element_blank(),
        # axis.ticks.x = element_blank(),
        # axis.ticks.length = unit(0.2, "cm"),
        # strip.text.x = element_text(hjust=0, size=14))
        panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15),
        strip.background = element_blank(),
        strip.text = element_text(size = 14, face = "bold"),
        panel.grid.major = element_blank(),  # remove major grid lines
        panel.grid.minor = element_blank())

```


## Indicator selection criteria

```{r indicator_justification, eval=TRUE}


# bar plot showing frequency of responses
data$Were.indicator..or.variable..selection.criteria.presented.%>% unique()
#[1] "Selection criteria presented"          "Based on reference only"               "Reference and a brief statement"      
#[4] "No selection criteria"                 ""                                      "Assessment against criteria presented"

#All blanks have 'Variable selection justified' selected in the related in the related indicator/variable questions
#But what do I mean by variable selection justified - these assessments don't have a selection criteria but provide supporting text on they key resilience factors that relate to resilience factors that confer resilience 
#replace all blanks with 'Indicator selection justified' using factor recode
# BC_2019_Djibouti
# RS_2016_Chuuk
# YMB_2022_GBR
# MP_2015_Riung
# BM_2017_PalkBay
# BC_2018_Comoros
# GR_2012_SaudiArabia

factor_order<-c("Assessment against criteria presented","Selection criteria presented",'',"Reference and a brief statement","Based on reference only","No selection criteria")

data %<>%  mutate(`indicator_selection`=`Were.indicator..or.variable..selection.criteria.presented.` %>% factor(levels = factor_order) %>%
                                 fct_recode(`Assessed against criteria`= "Assessment against criteria presented",
                                            `Yes`= "Selection criteria presented",
                                           `Ref only` = "Based on reference only",
                                           `Ref and brief statement` = "Reference and a brief statement",
                                           `No` = "No selection criteria",
                                           `Justified` = ""))

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(indicator_selection))) +
  geom_bar(aes(fill=indicator_selection))+
  theme_bw()+
  xlab('')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=16),
        axis.line = element_line(colour = "black"),
        text = element_text(size=16))

```

##Indicator groupings

```{r indicator_group, eval=TRUE}
# bar plot showing frequency of responses
data$Were.indicators.grouped.together.under.higher.level.classifications.%>% unique()#
#[1] "Yes"     "No"      "Unclear"

#Unclear - don't know as results were not presented AB_2010_CaymanIsl, AB_2011_SaudiArabia
#Yes means that sub-index scores were presented for these groups


#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(Were.indicators.grouped.together.under.higher.level.classifications., levels=c("No", "Yes", "Unclear")))) +
  geom_bar(aes(fill=Were.indicators.grouped.together.under.higher.level.classifications.))+
  theme_bw()+
  xlab('')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=16),
        axis.line = element_line(colour = "black"),
        text = element_text(size=16))

```

What were the groupings?

```{r indicator_groupings, eval=TRUE}

data$What.were.the.groupings.%>% unique()

#Split them to find out what groups are most popular. Not important to know the percentage of assessments, but rather just the count (frequency)

#first need to change , to ;
#Create a seperate dataset
ind_groups<-data %>% 
              mutate(groups=`What.were.the.groupings.`) %>% 
                select(Study.ID.1,groups) 

#Steps to get the frequency occurence of responses:
#need to create a unique list of responses
#first seperate responses into different columns
#rbind the columns into a single column/vector
#peform unique function on this
#recode the factors where necessary 
#perform unique to get final list

#split by ; into individual columns

#list of responses which need to be split again:
#"connectivity  \ngrouping 2 - resistance"
#management  \n2nd level - corals and ecology
#recovery and management

ind_groups %<>% 
  mutate(groups = gsub(",",";",groups),
         groups = gsub("\n",";",groups)) #sub commas for ; before splitting

ind_groups%<>%
  mutate(groups=groups  %>% factor() %>%
                fct_recode(`recovery;management`="Recovery and Management")
         )

str_split_fixed(ind_groups$groups, ";",20) #nothing in cols 20, so can shorten to 19

ind_groups_split<-str_split_fixed(ind_groups$groups, ";", 19)  %>% as.data.frame()
ind_groups_split$study<-ind_groups$Study.ID.1

#Change from wide to single, long column
data_long <- gather(ind_groups_split,study, values, V1:V19, factor_key=TRUE)


#add study column - this can then be used to look for duplication (multiple representation of same group per assessment) later
data_long$study2<-ind_groups_split$study

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace
data_long$values<- gsub('^\\-|\\-$', '', data_long$values) #removes leading -
data_long$values<-tolower(data_long$values) #converts all captial to lower

#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long$values %>% unique() %>% sort()


#CREATE NEW FACTOR GROUPINGS
data_long %<>%
  mutate(values2=values  %>% factor() %>%
                fct_recode(
                           `algal community`="algae",
                           `anthropogenic threats`="anthro impacts",
                           `anthropogenic threats`="anthropogenic",
                           `anthropogenic threats`="anthropogenic factors",
                           `anthropogenic threats`="stress factors",
                            # ``="anthropogenic threats",
                           `anthropogenic threats`="threats",
                           `benthic factors`="benthic",
                           `benthic factors`="grouping 1 - benthic",
                           `benthic factors`="benthic condition",
                           `benthic factors`="benthic cover",
                           # ``="benthic factors",
                           `bleaching resistance/sensitivity`="bleaching  sensitivity",
                           `bleaching resistance/sensitivity`="bleaching resistance factors",
                           `bleaching resistance/sensitivity`="bleaching resistance",
                           `bleaching resistance/sensitivity`="bleaching sensitivity",
                           `bleaching resistance/sensitivity`="bleaching tolerance/resistance",
                           `bleaching resistance/sensitivity`="resistance",
                           `bleaching resistance/sensitivity`="grouping 2 - resistance",
                           `broad-scale factors`="borad-scale",
                           `broad-scale factors`="broad-scale",
                           # ``="broad-scale factors",
                           `connectivity factors`="connectivity",
                           # `connectivity factors`="connectivity factors",
                           `connectivity factors`="transport connectivity",
                           `cooling & flushing`="cooling",
                           # ``="cooling & flushing",
                           `cooling & flushing`="cooling and flushing",
                           # ``="coral community",
                           `coral community`= "1st level - coral community",
                           `coral community`= "2nd level - corals and ecology",
                           `coral community`="coral population",
                           `coral community`="coral population factors",
                           `coral condition`="coral condition",
                           `coral condition`="current condition",
                           `coral condition`="current coral condition",
                           `coral condition`="current coral",
                           `herbivores`="ecological (herbivores)",
                           `herbivores`="ecological associates  (herbivores)",
                           `herbivores`="herbivory",
                           # `herbivores`="herbivores",
                           `positive/negative coral associates`="coral associates",
                           `positive/negative coral associates`="ecological associates (positive)",
                           `positive/negative coral associates`="ecological (positive)",
                           `positive/negative coral associates`="positive",
                           `positive/negative coral associates`="positive associates of corals",
                           `positive/negative coral associates`="ecological associates (negative)",
                           `positive/negative coral associates`="ecological (negative)",
                           `positive/negative coral associates`="negative",
                           `positive/negative coral associates`="negative associates of corals",
                           `positive/negative coral associates`="negative factors affecting corals",
                           `positive/negative coral associates`="enhancing",
                           `environmental factors`="environment",
                           `extremes and acclimitzation`="extremes",
                           `extremes and acclimitzation`="extremes & acclimatization",
                           `extremes and acclimitzation`="acclimatization",
                           `fish community`="fish community structure",
                           `fish community`="fish groups",
                           `fish community`= "other non-fish fish groups",
                           `fishing pressure`="fishing",
                           `historic coral condition`="historic condition",
                           `historic coral condition`="historic coral",
                           # ``="historic coral condition",
                           `historic coral condition`="impacts on corals",
                           `ecological interactions`="ecological interactions",
                           `ecological interactions`="interactions",
                           `local-scale factors`="local-scale",
                           `management feasibility`="locally manageable factors",
                           `management`="management intervention",
                           `management feasibility`="and management feasibility",
                           `physical factors`="physical",
                           `physical factors`="physical characteristics",
                           # ``="physical factors",
                           `predation`="predation rate",
                           `predation`="predators",
                           `recovery potential`="recovery",
                           `recovery potential`="recovery  potential",
                           # ``="recovery potential",
                           `shading and screening`="screening",
                           `shading and screening`="shade and screen",
                           `shading and screening`="shade & screen",
                           `shading and screening`="shade and screening", 
                           `shading and screening`="shading",
                           # ``="shading and screening",
                           `substrate quality`="substrate",
                           `substrate and morphology`="substrate & morphology",
                           `substrate quality`="substrate alterations",
                           `substrate quality`="substrate condition"
                           # ``="substrate and morphology",
                           # ``="substrate quality"
                           ))

data_long$values2 %>% unique() %>% order() #44 values

#When we group things together e.g. positive and negative associates, then we are artifically creating duplication, where it will be counted twice for one assessment if both indicators are used

#remove blank rows and then find any studies where the same group is repeated more than once
data_long %<>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() #remove NAs

p<-data_long %>% 
  group_by(study2,values2) %>% 
  summarise(n=length(values2)) #check what studies may have repeated groups

#However, in some cases, there were two sets of groupings which need to be considered - 2 assessments (DO_2011_Mafia, MC_2014_Thailand), no need to alter as considering all possible groups within an assessment

data_long %<>% 
  group_by(study2) %>% 
  summarise(nvals=values2 %>% unique())  #remove duplicates (only consider unique groups per assessment)

#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%
        group_by(nvals) %>% 
        count(nvals)  #frequency count of responses


#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data_plot, aes(x= reorder(factor(nvals),n), y=n)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('')+
  ylab('Number of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


##Data
```{r same_data, eval=TRUE}

# bar plot showing frequency of responses
data$Was.the.same.data.used.to.represent.more.than.one.factor.variable.%>% unique()#
#[1] "Yes"     "No"      "Unclear"

#Unclear is unsure or not enough detail on indicators used

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(Was.the.same.data.used.to.represent.more.than.one.factor.variable.))) +
  geom_bar(aes(fill=Was.the.same.data.used.to.represent.more.than.one.factor.variable.))+
  theme_bw()+
  xlab('Repeated use of data for different indicators')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```

```{r data_quality, eval=TRUE}
# bar plot showing frequency of responses
data$Were.data.quality.scores.assigned.1%>% unique()#
#"No"                     "Discussed data quality"

#Unclear is unsure or not enough detail on indicators used

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(Were.data.quality.scores.assigned.1))) +
  geom_bar(aes(fill=Were.data.quality.scores.assigned.1))+
  theme_bw()+
  xlab('Were data quality scores presented')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```

##Indicator testing

```{r indicator_performance, eval=TRUE}
# bar plot showing frequency of responses
data$What.aspects.of.indicator.performance.and.behaviour.were.presented..or.tested..%>% unique()#
#there is one blank - BS_2018_Samoa - should be changed to none - canT do this in fct_recode as will change all blank entries

#Create a seperate dataset
ind_testing<-data %>% 
              mutate(testing=`What.aspects.of.indicator.performance.and.behaviour.were.presented..or.tested..`) %>% 
                select(Study.ID.1,testing) %>%  
          mutate(testing=replace(testing,Study.ID.1 == "BS_2018_Samoa","none"),
                 testing=replace(testing,Study.ID.1 == "GR_2012_SaudiArabia","sensitivity"))


#split by ; into individual columns

str_split_fixed(ind_testing$testing, ";",4) #nothing in cols 3, so can shorten to 2

ind_test_split<-str_split_fixed(ind_testing$testing, ";", 2)  %>% as.data.frame()
ind_test_split$study<-ind_testing$Study.ID.1

#Change from wide to single, long column
data_long <- gather(ind_test_split,study, values, V1:V2, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace

data_long$values<-sub("^\\s+", "", data_long$values) #removesleading leading whitespace

#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long$values %>% unique()
# [1] none                                                                                                                        
# [2] redundancy
# [3] sensitivity
# [4] Other: n/a (model)
# [5] Other: - assess which indicators perform the best in â€˜predictingâ€™ the health of the coral community
# [6] measurability
# [7] Other:  - sensitivity analysis of the effect of changes to ideal negative and positive positions (references) on the overall RI score of sites
# [8] responsiveness

#responsiveness was selected once for Ford et al. 2018 - the primary objective is to assess the performance of the different indicators at detecting differences between sites in managed and unmanaged areas - is this sensitivity or responsiveness. Responsiveness relates to rate and speed (time) of response to change, which is more for tracking temporal changes. So this should only be sensitivity. Change @ source or adjust in factor recode

#assess which indicators perform the best in â€˜predictingâ€™ the health of the coral community - relevance to resilience

#Other: n/a (model) - Bozec - change to none below

#CREATE NEW FACTOR GROUPINGS
data_long %<>%
  mutate(values=values  %>% factor() %>%
                fct_recode(`sensitivity` = "Other:  - sensitivity analysis of the effect of changes to ideal negative and positive positions (references) on the overall RI score of sites",
                          `relevance` = "Other: - assess which indicators perform the best in â€˜predictingâ€™ the health of the coral community",
                          `NA` = "responsiveness",
                          `none` = "Other: n/a (model)"))

#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%    #remove the NAs
  filter(!values %in% "NA") %>%  #remove the manually assigned NA (was responsiveness)
  count(values)  #frequency count of responses

#calculate percentage occurences 
data_plot$percent<-(data_plot$n/nrow(data)*100) %>% round(1)

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data_plot, aes(x= reorder(factor(values),percent), y=percent)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('Indicator performance and behaviour presented/tested')+
  ylab('Percentage of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


Decided to change all the other responses to tested as not many and can go back to dataset to find out details

```{r results_validated, eval=TRUE}

# bar plot showing frequency of responses
data$Was.the.accuracy.of.the.resilience.results.validated. %>%  unique()

#select one option so single response per assessment

factor_order<-c("Assessment against criteria presented","Selection criteria presented",'',"Reference and a brief statement","Based on reference only","No selection criteria")

data %<>%  mutate(`resilience_accuracy`=`Was.the.accuracy.of.the.resilience.results.validated.`  %>%
                                 fct_recode(`not presented`= "not considered/not done",
                                            `tested`= "correlation e.g. between resistance ~bleaching incidence",
                                            `tested`= "Other: Validation of the reconstructed trajectories of coral cover at the reef level with independent coral cover observations",
                                            `tested`= "Other: - statistical: coefficient of determination\tbased on the\tregression of\tpredictions against observations\t",
                                            `tested`= "Other: statistical models and tests e.g. Generalised Additive Models (GAM) or simpler Generalised Linear Models (GLM)",
                                                                                        `considered`= "Other: - discussed qualitatively",

                                                                                        `tested`= "Other: correlation (recovery ~ scores) and spatial comparisons",

                                           `tested` = "Other: Regression/correlation"))

factor_order<-c("not presented","considered","tested")

data%<>% mutate(`resilience_accuracy`=resilience_accuracy %>% 
               factor(levels = factor_order))

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(resilience_accuracy))) +
  geom_bar(aes(fill=resilience_accuracy))+
  theme_bw()+
  xlab('Was.the.accuracy.of.the.resilience.results.validated.')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))




```


##Uncertainty and variance
Is uncertainty (or variance) represented with final results/scores? has many blank responses as it was superseeded by the question Is variance represented with resilience results/scores?

Ignore the original question

```{r variance, eval=TRUE}
#MCQ

# bar plot showing frequency of responses
data$Is.variance.represented.with.resilience.results.scores. %>% unique()
#11 unique responses, some assessments with >1 selection
#no blanks, no other
# one unclear response from AB_2010_CaymanIsl as no results presented


#Create a seperate dataset
variance<-data %>% 
              mutate(vari=`Is.variance.represented.with.resilience.results.scores.`) %>% 
                select(Study.ID.1,vari)


#split by ; into individual columns

str_split_fixed(variance$vari, ";",4) #nothing in cols 3, so can shorten to 2

var_split<-str_split_fixed(variance$vari, ";", 2)  %>% as.data.frame()
var_split$study<-variance$Study.ID.1

#Change from wide to single, long column
data_long <- gather(var_split,study, values, V1:V2, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace

data_long$values<-sub("^\\s+", "", data_long$values) #removesleading leading whitespace

#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long$values %>% unique()
# [1] "No"                                                         "each indicator across all assessment units"                
# [3] "indicator @ spatial scale of assessment"                    "total resilience index scores @ aggregated spatial scale"  
# [5] "Unclear"                                                    "total resilience index scores @ spatial unit of assessment"
# [7] "" 


#CREATE NEW FACTOR GROUPINGS

factor_order<-c("No", "indicator @ spatial scale of assessment", "each indicator across all assessment units",  "total resilience index scores @ spatial unit of assessment", "total resilience index scores @ aggregated spatial scale","Unclear")

data_long %<>%
  mutate(values=values  %>% factor(levels = factor_order) %>% 
                fct_recode(`indicator_variance` = "each indicator across all assessment units",
                          `indicator_spatial_unit` = "indicator @ spatial scale of assessment",
                          `index_aggregated` = "total resilience index scores @ aggregated spatial scale",
                          `index_spatial_unit` = "total resilience index scores @ spatial unit of assessment",
                          `not presented`="No"))

#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%    #remove the NAs
  count(values)  #frequency count of responses

#calculate percentage occurences 
data_plot$percent<-(data_plot$n/nrow(data)*100) %>% round(1)

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data_plot, aes(x= factor(values), y=percent)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('Is variance presented with resilience scores')+
  ylab('Percentage of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))



```


```{r variance_type, eval=TRUE}
#MCQ

data$Type.of.variance %>% unique()
#11 unique responses, some assessments with >1 selection
#blanks should be converted to not presented
#All blank assessments had response No (or Unclear) for Is variance represented with resilience results/scores? - so there is consistency here

#Create a seperate dataset
variance_type<-data %>% 
              mutate(vari_type=`Type.of.variance`) %>% 
                select(Study.ID.1,vari_type) %>% 
          mutate(vari_type=replace(vari_type,vari_type == "","no variance presented"))


#split by ; into individual columns

str_split_fixed(variance_type$vari_type, ";",4) #nothing in cols 4, so can shorten to 3

var_type_split<-str_split_fixed(variance_type$vari_type, ";", 3)  %>% as.data.frame()
var_type_split$study<-variance_type$Study.ID.1

#Change from wide to single, long column
data_long <- gather(var_type_split,study, values, V1:V3, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace

data_long$values<-sub("^\\s+", "", data_long$values) #removesleading leading whitespace

#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long$values %>% unique()
# ""                              "Standard deviation"            "Standard error"               
# [4] "Other: Unknown"                "Other: max, min, range"        "Other: unknown"
# [7] "Confidence Interval"           "Other: 50% uncertainty bounds" "Other: IQR"                   
# [10] "Other: IQR, max, min"          "Other"                         "Other: min and max values"    
# [13] "Other: minimum"                "Other:  minimum, maximum"      "Other: min and max"           
# [16] "Other: min, max"               "Other: - IQR"       

#"Other: IQR, max, min" - from Gibbs and West, can be considered as just max,min

#CREATE NEW FACTOR GROUPINGS

factor_order<-c()

data_long %<>%
  mutate(values=values   %>% 
                fct_recode(
                          #`` = "Other: max, min, range",
                          `Unknown` = "Other: Unknown",
                          `Unknown` = "Other: unknown",
                          `Confidence Interval` = "Other: 50% uncertainty bounds",
                          `IQR`="Other: IQR",
                          #``="Other: IQR, max, min",
                          `Unknown` = "Other",
                          `min and max` = "Other: min and max values",
                          `minimum` = "Other: minimum",
                          `min and max` = "Other:  minimum, maximum",
                          `min and max` = "Other: min and max",
                          `min and max` = "Other: min, max",
                          `IQR` = "Other: - IQR"))


#because there are some responses which are still combined, need to go through splitting process again

str_split_fixed(data_long$values, ",",4) #nothing in cols 4, so can shorten to 3
var_type_split2<-str_split_fixed(data_long$values, ",", 3)  %>% as.data.frame()

#Change from wide to single, long column
data_long2 <- gather(var_type_split2,study, values, V1:V3, factor_key=TRUE)
data_long2$values<-sub("^\\s+", "", data_long2$values) #removesleading whitespace
data_long2$values<-sub("^\\s+", "", data_long2$values) #removesleading leading whitespace

data_long2$values %>% unique()

data_long2 %<>%
  mutate(values=values   %>% 
                fct_recode(
                          `IQR`="Other: IQR",
                          `min and max` = "min",
                          `delete` = "max",
                          `delete`= "Other: max",
                          `range`=" range")) #delete max as already represented in min

data_long2$values %>% unique()


#will just need to create a new matrix with the method and frequency
data_plot<-data_long2 %>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%    #remove the NAs
  filter(!values %in% 'delete') %>% 
  count(values)  #frequency count of responses

#calculate percentage occurences 
data_plot$percent<-(data_plot$n/nrow(data)*100) %>% round(1)

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data_plot, aes(x= factor(values), y=percent)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('Interval')+
  ylab('Percentage of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```

```{r uncertainty_sources, eval=TRUE}
#MCQ

data$What.sources.of.uncertainty.were.considered.during.index.construction. %>% unique()
#10 unique responses, some assessments with >1 selection
#All blank assessments should be changed to none

#Create a seperate dataset
uncertainty_sources<-data %>% 
              mutate(uncertain_source=`What.sources.of.uncertainty.were.considered.during.index.construction.`) %>% 
                select(Study.ID.1,uncertain_source) %>% 
          mutate(uncertain_source=replace(uncertain_source,uncertain_source == "","none"))


#split by ; into individual columns

str_split_fixed(uncertainty_sources$uncertain_source, ";",4) #nothing in cols 4, so can shorten to 3

uncertainty_source_split<-str_split_fixed(uncertainty_sources$uncertain_source, ";", 3)  %>% as.data.frame()
uncertainty_source_split$study<-uncertainty_sources$Study.ID.1

#Change from wide to single, long column
data_long <- gather(uncertainty_source_split,study, values, V1:V3, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace

data_long$values<-sub("^\\s+", "", data_long$values) #removesleading leading whitespace

data_long$values %>% unique()
#  [1] "none"                                      "method"                                   
#  [3] "Other: index results not presented"        "Other: - model uncertainty"               
#  [5] "Other:  - model uncertainty"               "Other: - not sure"                        
#  [7] "Other: NA"                                 "Other: weighting"                         
#  [9] ""                                          "data quality"                             
# [11] "Other: - data collection/sampling methods"     


#CREATE NEW FACTOR GROUPINGS

#factor_order<-c()

data_long %<>%
  mutate(values=values   %>% 
                fct_recode(
                          `none`="Other: index results not presented",
                          `model uncertainty`= "Other: - model uncertainty",
                          `model uncertainty`= "Other:  - model uncertainty",
                          `unsure`= "Other: - not sure",
                          `none`="Other: NA",
                          `weight`="Other: weighting",
                          `data collection methods`="Other: - data collection/sampling methods"))

#Other: NA is from AB_2011_SaudiArabia
#Other: index results not presented - AB_2010_CaymanIsl
#change both AB studies to none

data_long$values %>% unique()


#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%    #remove the NAs
  count(values)  #frequency count of responses

#calculate percentage occurences 
data_plot$percent<-(data_plot$n/nrow(data)*100) %>% round(1)

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data_plot, aes(x= factor(values), y=percent)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('Uncertainty sources')+
  ylab('Percentage of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))



```


##Composite Index

```{r individual_indicators, eval=TRUE}
#MCQ
data$Were.individual.indicator.results.scores.at.the.assessment.scale..e.g..site..presented.through.figures.graphs.or.tables. %>% unique()
#4 responses
#"Yes - all"  "No"         "Yes - some" "" 

#2 blank assessments - Bozec, Conklin 2016 - Yes - all (presented all indicators at site level)
#Bozec is a modelled approach, so for consistency with other modelled assessments e.g. Mellin 2019 - set as No


factor_order<-c("No","Yes - some", "Yes - all")

data %<>%  mutate(`Individual_indicator`=`Were.individual.indicator.results.scores.at.the.assessment.scale..e.g..site..presented.through.figures.graphs.or.tables.`  %>% replace(Study.ID.1=="EC_2016_Hawaii","Yes - all") %>% 
                                  replace(Study.ID.1=="YMB_2022_GBR","No") %>% 
                                factor(levels = factor_order))

#plot
#produce a simple frequency histogram of occurences of totals - number of assessments with each total
ggplot(data, aes(x= factor(Individual_indicator))) +
  geom_bar(aes(fill=Individual_indicator))+
  theme_bw()+
  xlab('Were individual indicator results presented')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```


```{r score_normalisation, eval=TRUE}
#MCQ but single response per assessment

data$How.were.aggregated.final.scores.normalised.standardised. %>% unique()

#Only useful for the  empirical indicator approach and if an index was calculated

#filter accordingly:
#  [1] "They weren't"              
#  [2] "Against the highest score"    
#  [3] "Other: - euclidean distance to INS divided by sum of a sites euclidean distance to INS and IPS " 
#  [4] "Other: results not presented"      
#  [5] "Other: not applicable with model approach"
#  [6] "Other: N/A (not combined)"             
#  [7] "Other: index results not presented"   -  AB_2010_CaymanIsl (no results)
#  [8] "Other: Unclear"                       
#  [9] "Other: N/A (not quantitative)"    -    RS_2016_Palmyra (no indicators)
# [10] "Other: n/a (model)"           
# [11] "Other: not combined"         
# [12] "Other: n/a (model output)"    
# [13] "Other: not done/NA"           - MS_2019_Thailand (no index)
# [14] "Other: n/a (not combined)"    
# [15] "Other: N/S (not combined)"    
# [16] "Other: standardised: score minus mean-score divided by two times score standard deviation"
# [17] "Other: probability that a reef remained in its coral-based stability domain, given its initial state, physical environment, and anticipated disturbance regime"

#filter
#What type of resilience potential assessment is this?=expert set of (normalised) resilience indicators

exclude_composite<-c("Other: results not presented","Other: N/A (not combined)",             
"Other: index results not presented",
"Other: N/A (not quantitative)",
"Other: not combined" ,
"Other: not done/NA"   ,        
"Other: n/a (not combined)",    
"Other: N/S (not combined)")

  speech<- data %>% mutate(`normalised_scores`=`How.were.aggregated.final.scores.normalised.standardised.`)  %>% 
                      filter(`What.type.of.resilience.potential.assessment.is.this.` %in% "expert set of (normalised) resilience indicators") %>% 
                      filter(!`How.were.aggregated.final.scores.normalised.standardised.` %in% exclude_composite)
  
  speech$normalised_scores %>% unique()
# [1] "They weren't"                                                                                   
# [2] "Against the highest score"                                                                      
# [3] "Other: - euclidean distance to INS divided by sum of a sites euclidean distance to INS and IPS "
# [4] "Other: Unclear"                                                                                 
# [5] "Other: standardised: score minus mean-score divided by two times score standard deviation"      

  speech %<>%
  mutate(normalised_scores=normalised_scores   %>% 
                fct_recode(
                          `Unclear`="Other: Unclear",
                          `Not normalised`= "They weren't",
                          `Other method`= "Other: - euclidean distance to INS divided by sum of a sites euclidean distance to INS and IPS ",
                          `Other method`="Other: standardised: score minus mean-score divided by two times score standard deviation"))
  
  ggplot(speech, aes(x= factor(normalised_scores))) +
  geom_bar(aes(fill=normalised_scores))+
  theme_bw()+
  xlab('How were aggregated final scores normalised')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```

CHECK - make sure all those marked as They weren't are in fact an index e.g. MS_2011_Metundo don't calculate an index


How were sites ranked?

```{r ranking_sites, eval=TRUE}
#more interested in the different options rather than the frequency of use

  data$How.were.sites.ranked. %>% unique()

data$Study.ID.1[which(data$How.were.sites.ranked.=="")]  #GR_2012_SaudiArabia
data$Study.ID.1[which(data$How.were.sites.ranked.=="N/A")] #"BM_2017_PalkBay" "AK_2013_Fiji"
data$Study.ID.1[which(data$How.were.sites.ranked.=="unclear")] #MS_2019_Thailand
data$Study.ID.1[which(data$How.were.sites.ranked.=="results not presented")] #"AB_2010_CaymanIsl"   "AB_2011_SaudiArabia"
data$Study.ID.1[which(data$How.were.sites.ranked.=="Unknown")] #PIFSC_2014_Hawaii
data$Study.ID.1[which(data$How.were.sites.ranked.=="not applicable")] #SA_2011_Indonesia
data$Study.ID.1[which(data$How.were.sites.ranked.=="not done")]
data$Study.ID.1[which(data$How.were.sites.ranked.=="n/a")] #NTL_2019_Vietnam
data$Study.ID.1[which(data$How.were.sites.ranked.=="not ranked")] #PM_2014_Caribbean
data$Study.ID.1[which(data$How.were.sites.ranked.=="No ranking")] #RS_2014_SavuSea
data$Study.ID.1[which(data$How.were.sites.ranked.=="Not ranked")] #RS_2016_Palmyra

data$Study.ID.1[which(data$How.were.sites.ranked.=="3 categories of high, medium, low based on overall resilience index score")] #DM_2016_EastAfrica -> this should be for the next question on overall levels classified
#error - mixed up responses for these two questions - 3 categories based on max and min value across all sites


#This is a methodological question, so all assessments regardless of if results are presented should be included

#not done and not ranked (and various alternatives) should be considered the same

#Unknown - PIFSC, change to composite resilience scores

#All assessments are applicable regardless of method and whether a composite index is calculated - so all blanks and N/As should be changed to not ranked

#Will calculate as number of assessments rather than percentage of assessments

data$How.were.sites.ranked.<-sub("^\\s+", "", data$How.were.sites.ranked.) #removesleading whitespace
data$How.were.sites.ranked.<- sub("\\s+$", "", data$How.were.sites.ranked.) #removes trailing whitespace
data$How.were.sites.ranked.<- gsub('^\\-|\\-$', '', data$How.were.sites.ranked.) #removes leading -
data$How.were.sites.ranked.<-sub("^\\s+", "", data$How.were.sites.ranked.) #removesleading whitespace
data$How.were.sites.ranked.<-tolower(data$How.were.sites.ranked.) #converts all captial to lower




 data %<>%
  mutate(ranked=How.were.sites.ranked.   %>% 
                fct_recode(
                          `not ranked`="",
                          `not ranked`= "N/A",
                          `highest to lowest resilience score`= "unknown",
                          `not ranked`= "unclear",
                          `not ranked`="results not presented",
                          `not ranked` = "not applicable",
                          `not ranked` = "not done",
                          `not ranked`= "n/a",
                          `not ranked`= "no ranking",
                          `not ranked`= "not ranked",
                          `highest to lowest resilience score`="highest to the lowest final resilience value",
                          `highest to lowest resilience score`="overall resilience score",
                          `highest to lowest resilience score`="total resilience score",
                          `highest to lowest resilience score`="highest to lowest resilience scores",
                          `highest to lowest resilience score`="based on overall resilience scores",
                          `highest to lowest resilience score`="highest to lowest resilience score",
                          `highest to lowest resilience score w/ and without mgt index scores`="highest to lowest aggregate resilience scores but with and without management index scores",
                          `highest to lowest resilience score`="highest overall resilience to the lowest",
                          `highest to lowest resilience score`="normalised resilience score",
                          `highest to lowest resilience score`="from high to low resilience score",
                          `highest to lowest resilience score`="from high to low",
                          `highest to lowest resilience score`="highest to lowest anchored resilience score",
                          `highest to lowest resilience score`="total index value",
                          `highest to lowest resilience score`="based on normalised resilience scores",
                          `highest to lowest resilience score`="mean resilience index score",
                          `highest to lowest resilience score`="based on raw index scores",
                          `highest to lowest resilience score`="highest to lowest normalised resilience score",
                          `highest to lowest resilience score`="based on raw overall index scores",
                          `highest to lowest resilience score`="highest to lowest normalised resilience score",
                          `highest to lowest resilience score`="by highest normalised relative resilience potential",
                          `highest to lowest resilience score`="sites are ranked from highest to lowest resilience score",
                          `highest to lowest resilience score`="composite resilience scores",
                          `highest to lowest resilience score`="based on average ri score",
                          `highest to lowest resilience score`="3 categories of high, medium, low based on overall resilience index score",
                          `highest to lowest resilience score`="by weighted final resilience scores",
                          `highest to lowest resilience score`="ranked from highest to lowest index score",
                          `highest to lowest resilience score`="the average scores for all the resilience indicators was used to produce a ranking of the stations from highest to\nlowest overall resilience.",
                          `highest to lowest resilience score`="based on net rs score",
                          `highest to lowest resilience score`="sites are ranked from highest to lowest resilience",
                          `highest to lowest resilience score`="overall resilience",
                          `relative proximity to the ideal solutions`="based on relative proximity to the ideal solutions",
                          `recovery potential score`="by total score and by recovery potential score",
                          `recovery potential score w/bleaching resistance, threats, mgt feasibility`="the rankings for bleaching tolerance/resistance, recovery potential, threats,and management feasibility for each site are listed in the table below. recovery potential was considered most important in determining higher ranking for sites.",
                          `greatest manageable and the least unmanageable threats`="highest to lowest but also highest priority to places facing the greatest manageable(local) threats and the least unmanageable(global) threats",
                          `Other`="this formula was calculated for each site, and interpolated for each state, and mapped. all the interpolations (kriging) of the datasets were undertaken using the statistical software r"))
 
 data$ranked %>% unique()
  
  ggplot(data, aes(x= factor(ranked))) +
  geom_bar(aes(fill=ranked))+
  theme_bw()+
  coord_flip()+
  xlab('How were sites ranked')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```


##classifications of resilience levels
How was overall resilience level classified for sites?

```{r level_classification, eval=TRUE}

#JUST WANT A LIST OF VARIOUS OPTIONS
#this mainly applies to where indices are calculated


#there is a difference between what were the overall classifications e.g. high, med, low or 0.5 to 0.7, 0.7-1, and how these classifications were calculated

#e.g. ET_2022_Bazaruto, we know what the classifications are but not how they were derived

data$How.was.overall.resilience.level.classified.for.sites.<-sub("^\\s+", "", data$How.was.overall.resilience.level.classified.for.sites.) #removesleading whitespace
data$How.was.overall.resilience.level.classified.for.sites.<- sub("\\s+$", "", data$How.was.overall.resilience.level.classified.for.sites.) #removes trailing whitespace
data$How.was.overall.resilience.level.classified.for.sites.<- gsub('^\\-|\\-$', '', data$How.was.overall.resilience.level.classified.for.sites.) #removes leading -
data$How.was.overall.resilience.level.classified.for.sites.<-tolower(data$How.was.overall.resilience.level.classified.for.sites.) #converts all captial to lower

data$How.was.overall.resilience.level.classified.for.sites. %>% unique()
  
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="")]  #DO_2011_Mafia - not done
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="n/a")] #"BM_2017_PalkBay" 
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="unclear")] #[1] "RS_2011_Palau"               "MS_2019_Thailand"            "RA_2014_India"               "TM_2012_ KarimunjawaIslands" "Bang_2021_Taiwan"
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="not done")] 
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="unknown")] #"TA_2008_Philippines" "ET_2022_Bazaruto"    "PIFSC_2014_Hawaii"   "RS_2017_Maldives"  
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="not applicable")] #SA_2011_Indonesia
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="results not presented")] #AB_2010_CaymanIsl
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="unclear/unknown")] #FI_2021_Belitung
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="unclear/not presented")] #AB_2011_SaudiArabia
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="no classifications")] #BC_2018_Comoros
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="not classified")] #GR_2012_SaudiArabia
data$Study.ID.1[which(data$How.was.overall.resilience.level.classified.for.sites.=="unsure")] #AK_2013_Fiji


#group all the unsure, unclear, unknown into unclear
#not classified and no classifications into not done

data %<>%
  mutate(classified=How.was.overall.resilience.level.classified.for.sites.   %>% 
                fct_recode(
                          `not done`="",
                          `not done`= "no classifications",
                          `not done`= "not classified",
                          `unclear`= "unsure",
                          `unclear`= "unknown",
                          `n/a`= "not applicable",
                          `unclear`= "unclear/unknown",
                          `unclear`= "results not presented",
                          `unclear`= "unclear/not presented", 
                          `range divided into equal classes`="the range in each score for each component was divided into 5 classes of equal width",
                          `mean+sd`="high (final scores that are greater than 1 sd above average), medium-high (<avg+1sd and >avg), medium-low (<avg and >avg-1sd), and low (<avg-1sd).",
                          `expert judgment`="estimated resilience potential for the coral community at each site",
                          `range divided into equal classes`="the total range was then divided by three to identify the ranges for low, medium, and high",
                          `range divided into equal classes`="dividing range of resilience scores into 3 equal classes",
                          `range divided into equal classes`="range of total resilience scores divided equally into 3 classes",
                          `range divided into equal classes`="range of resilience scores divided into 3 equal classes",
                          `expert judgment`="based on personal interpretation of indicators",
                          `arbitrary`="sites with an anchored resilience score of 0.8 to 1 are considered to have high (relative) resilience potential, 0.6-0.79 medium, and <0.6 is low",
                          `arbitrary`="0.8â“1: high resilience; 0.6â“0.79: medium resilience; < 0.6: low resilience",
                          `other`="based on coral performance in 2020 as the difference between total coral cover and simulated equilibrial coral cover. equilibrium states i.e. long-term averages around which coral cover fluctuates in a given reef environment.",
                          `below and above median coral cover decline and disturbance level`="low and\thigh categories corresponded to values below and\tabove the median coral cover decline and disturbance level",
                          `arbitrary`="scores of 0 to 0.2 rated as â˜very poorâ™, >0.2 to 0.4 rated as â˜poorâ™, >0.4 to 0.6 rated as â˜moderateâ™, >0.6 to 0.8 rated as â˜goodâ™",
                          `mean+sd`="high (â‰¥ avg. + 1 sd), medium-high (â‰¥ avg. and < avg. + 1 sd), medium-low (â‰¥ avg. and > avg. 1 sd), low (<avg. - 1 sd)",
                          `1-5 scale`="using mean - 1 to 5 (poor to good)",
                          `mean+sd`="low (more than 1 sd below the mean), medium (within 1 sd below the mean), high (within 1 sd above the mean) and very high (more than 1 sd above the mean)",
                          `mean+sd`="high (final scores that are greater than 1 standard deviation (sd) above average), medium-high (<avg+1sd and >avg), medium-low (<avg and >avg-1sd), and low (<avg-1sd)",
                          `mean+sd`="high (scores that are >1 sd above average (avg) and <1), medium-high (<avg+1sd and >avg), medium-low (<avg and >avg-1sd), and low (<avg-1sd)",
                          `mean+sd`="mean plus/minus sd",
                          `mean+sd`="based on the average (avg) final normalised resilience score (0.77) and standard deviation (sd) (0.16): high (>avg+1sd), med-high (>avg & <avg+1sd), med-low (<avg & >avg-1sd), and low (<avg-1sd)",
                          `mean+sd`="",
                          `arbitrary`="10 bins divided into equal 0.1",
                          `quartiles`="split into quartiles",
                          `range divided into equal classes`="range of resilience scores divided into 3 equal groups",
                          `range divided into equal classes`="using range of resilience values across sites (subtracting max and min)",
                          `range divided into equal classes`="3 categories based on max and min value across all sites",
                          `range divided into equal classes`="subtracting the lowest score from the  highest  score  for each category  and  then  dividing  the total  range  by  three to  identify  the  ranges  for low, medium, and high",
                          `gradient based on highest to lowest`="no explicit classifications, looks like gradual gradient based on highest to lowest",
                          `mean+sd`="based   on   the   mean   and standard deviation of a normal distribution",
                          `mean+sd`="high resilience (value>avg + 1 sd); medium-high resilience (value>avg and <avg + 1 sd); medium-low resilience (value <avg and>avg - 1 sd); low resilience (value <avg - 1 sd)",
                          `1-5 scale`="5, good for corals to red 1, poor for corals",
                          `mean+sd`="high (scores that are >1 sd above average (avg) and <1), medium-high (<avg+1sd and >avg), medium-low (<avg and >avg-1sd), and low (<avg-1sd)",
                          `unsure (maybe nmds groupings)`="not classified (though they did group sites using an nmds)",
                          `unsure (maybe nmds groupings)`="unclear (could be using nmds groupings)"))
                         
k<-data$classified %>% unique()


ggplot(data, aes(x= factor(classified))) +
  geom_bar(aes(fill=classified))+
  theme_bw()+
  coord_flip()+
  xlab('How were resilience levels classified')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


##Weighting
How were indicators weighted in the model?
```{r weighting, eval=TRUE}

  data$How.were.indicators.weighted.in.the.model. %>% unique()

#  [1] "Equal"                                "Unequal"                              "Other: unknown"                      
#  [4] "Other: Unknown "                      ""                                     "Other: Unknown"                      
#  [7] "Other: N/A (not combined)"            "Other: results not presented"         "Other: model approach"               
# [10] "Other: n/a (model approach)"          "Other: unclear"                       "Other: n/a (not combined)"           
# [13] "Other: "                              "Other: N/A (not aggregated)"          "Varied e.g. scenarios"               
# [16] "Other: N/A (indicators not combined)" "Other: Unsure" 

#some blank (1) -SA_2011_Indonesia

#can't consider if no index, combination of indicators

#maybe only consider the subset of assessments 'expert set of (normalised) resilience indicators' & those which used index & those which present results

#since this is a methodological question, whether results are presented or not should not make a difference
#Other: results not presented"; Other:  , are the two Bruckner reports AB_2010_CaymanIsl,AB_2011_SaudiArabia
#Keep both in but recode for Unknown


exclude_weight<-c("Other: n/a (not combined)",             
"Other: N/A (not combined)",
"Other: N/A (not aggregated)",
"Other: N/A (indicators not combined)")

  weights<- data %>% mutate(`weight`=`How.were.indicators.weighted.in.the.model.`)  %>% 
                      filter(`What.type.of.resilience.potential.assessment.is.this.` %in% "expert set of (normalised) resilience indicators") %>% 
                      filter(!`How.were.indicators.weighted.in.the.model.` %in% exclude_weight)
  
  weights$weight %>% unique()

# [1] "Equal"                        "Unequal"                      "Other: unknown"              
# [4] "Other: Unknown "              "Other: Unknown"               "Other: results not presented"
# [7] "Other: unclear"               "Other: "                      "Varied e.g. scenarios
#   
   weights %<>%
  mutate(weight=weight   %>% 
                fct_recode(
                          `Unclear`="Other: unknown",
                          `Unclear`= "Other: Unknown ",
                          `Unclear`= "Other: Unknown",
                          `Unclear`="Other: unclear",
                          `Unclear` = "Other: ",
                          `Unclear` = "Other: results not presented",
                          `Multiple`= "Varied e.g. scenarios"))
  
  ggplot(weights, aes(x= factor(weight))) +
  geom_bar(aes(fill=weight))+
  theme_bw()+
  xlab('How were indicators weighted in the model')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


What was the rationale and method used to determine weights?
```{r weight_rationale, eval=TRUE}

#Need the same exclusion criteria as the previous weight question for consistency

data$What.was.the.rationale.and.method.used.to.determine.weights. %>% unique()
#14 options including blanks

weight_rationale<- data %>% mutate(`weight_rat`=`What.was.the.rationale.and.method.used.to.determine.weights.`)  %>% 
                      filter(`What.type.of.resilience.potential.assessment.is.this.` %in% "expert set of (normalised) resilience indicators") %>% 
                      filter(!`How.were.indicators.weighted.in.the.model.` %in% exclude_weight)
  

  weight_rationale$weight_rat %>% unique()
#12 options including 1 blank - AB_2010_CaymanIsl

#All these were listed as similar previous study or empirical evidence or expert opinion/judgement. Need to clarify how many use McClanahan et al. 2012:
# TP_2018_Indonesia - perceived importance of each indicator (in McClanahan et al., 2012) - expert opinion/judgement
# FJ_2022_SWIO - perceived importance for coral reef recovery, ranked by a survey through the “Coral-list” - expert opinion/judgement
# RS_2010_Mozambique - based on confidence from experts - expert opinion/judgement
# AM_2019_Wakatobi - importance for each indicator of McClanahan et al. (2012) - expert opinion/judgement
# JM_2015_CNMI - McClanahan et al. 2012 - expert opinion/judgement
# TM_2012_ KarimunjawaIslands - perceived importance of each indicator - expert opinion/judgement
# JM_2010_GBR - the strength of the relationship between the indicator  and  reef  resilience  as  evidenced  in  published literature  (see  Table1 for  references)  and,  for  indicators that relate to anthropogenic impacts, (2) applicability to the case study region. Indicators with strong links to resilience have  been  classified  as  ‘critically  important’ - empirical evidence and local relevance
  
# CL_2013_Mexico - Indicators were assigned weights based on current published literature demonstrating the importance of these indicators in contributing to or detracting from coral reef resilience in combination with site-specific characteristics of the PNAPM (Ladd 2011) -  empirical evidence and local relevance
  
# Bang_2021_Taiwan - Studies that have tested indicators under a variety of weighting systems have also showed that the resulting management actions and derived outcomes were largely unaffected by the weighting (Gibbs and West,2019). Thus, the indicators in our resilience assessments were equally weighted -> empirical evidence

  #Other: local observations is from Rowland 2012 -> empirical evidence and local relevance
 
  #[3] "expert opinion/judgement; Other:  - based on weight of other variables" is from Jouval 2022 and can be simpolified to expert opinion/judgement since the weight of theother variable was also derived this way   
  
  #[3] Other: based on most unambiguous and most reliably quantitative indicators - from DO_2011_Mafia -> Unclear

   weight_rationale %<>%
  mutate(weight_rat=weight_rat   %>% 
                fct_recode(
                          `arbitrary`="",
                          `arbitrary`= "arbitrary/unknown/undefined",
                          `empirical evidence and local relevance`= "Other: local observations",
                          `unclear`="Other: based on most unambiguous and most reliably quantitative indicators",
                          `empirical evidence`="similar previous study") %>% 
           replace(Study.ID.1=="TP_2018_Indonesia","expert opinion/judgement") %>% 
           replace(Study.ID.1=="FJ_2022_SWIO","expert opinion/judgement") %>% 
           replace(Study.ID.1=="RS_2010_Mozambique","expert opinion/judgement") %>% 
           replace(Study.ID.1=="AM_2019_Wakatobi","expert opinion/judgement") %>% 
           replace(Study.ID.1=="JM_2015_CNMI","expert opinion/judgement") %>% 
           replace(Study.ID.1=="TM_2012_ KarimunjawaIsland","expert opinion/judgement") %>% 
           replace(Study.ID.1=="JM_2010_GBR","empirical evidence and local relevance") %>% 
           replace(Study.ID.1=="CL_2013_Mexico","empirical evidence and local relevance"))
   
     weight_rationale$weight_rat %>% unique()

   
  
  ggplot(weight_rationale, aes(x= factor(weight_rat))) +
  geom_bar(aes(fill=weight_rat))+
  theme_bw()+
  coord_flip()+
  xlab('')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=16),
        axis.line = element_line(colour = "black"),
        text = element_text(size=16))

```

How many equal weights are abitrary, distinguish from when the weight is unknown

#Management



Was the assessment used to directly inform management?
```{r mgt_inform, eval=TRUE}
#One selection per assessment

data$Was.the.assessment.used.to.directly.inform.management. %>% unique()

#there are some blanks - RS_2017_Palau
#oversight during extraction. No changed in source yet. There is a section called Implications of resilience for management of the Palau reef system, where they make suggestions using the resilience scores
#Key local scale indicators of anthropogenic stress and management feasibility for coral reefs that should be included but were not for this exercise - therefore is not analytical, but is a descriptive approach

#New issues (20 Feb 23) - Rod Salm 2 papers (ET_2022 and RS_2016_Chuuk) are listed as analytical but method to prioritise does not corroborate this - check all analytical assignments
# Both Salm -  change to descriptive because they use the resilience scores to decide on suitable mgt approach, no calculation of a mgt potential index or mgt feasability, or based on observations across all resilience indicators and personal interpretation and total resilience scores

#BC_2018_Comoros - because he calculated stress indicators separately to the vulnerability index, and used them to inform descriptively (steps should be taken to prevent  further  erosion  and  pollution entering  coastal  waters  by  protecting  forest  on the  island’s  steep  volcanic  slopes  and addressing  water  supply  for  domestic  use) then should be analytical. consistent with some salm and EM_2012_Micronesia


data %<>%  mutate(`inform_mgt`=`Was.the.assessment.used.to.directly.inform.management.`  %>% replace(Study.ID.1=="RS_2017_Palau","descriptive/explanation/discussion (sub-section or 1-2 paragraphs)") %>% 
    replace(Study.ID.1=="ET_2022_Bazaruto","descriptive/explanation/discussion (sub-section or 1-2 paragraphs)") %>% 
    replace(Study.ID.1=="RS_2016_Chuuk","descriptive/explanation/discussion (sub-section or 1-2 paragraphs)")%>% 
    replace(Study.ID.1=="BC_2018_Comoros","analytical evaluation e.g. intervention prioritisation, intervention effect evaluation")) 

#no more blanks

data %<>%
  mutate(inform_mgt=inform_mgt   %>% 
                fct_recode(
                          `descriptive`="descriptive/explanation/discussion (sub-section or 1-2 paragraphs)",
                          `analytical evaluation`= "analytical evaluation e.g. intervention prioritisation, intervention effect evaluation",
                          `tangible outcomes`= "actual/tangible management outcomes (informed management, policy)",
                          `general connection`="general connection to management (not related to actual results)â€“  the odd, general statement/recommendation in the discussion"))


  ggplot(data, aes(x= factor(inform_mgt))) +
  geom_bar(aes(fill=inform_mgt))+
  theme_bw()+
  xlab('')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=16),
        axis.line = element_line(colour = "black"),
        text = element_text(size=16))

```


Were any factors/indicators linked to management actions?
```{r mgt_factors, eval=TRUE}

data$`Were.any.factors.indicators.linked.to.management.actions.`%>% unique()

#"No"      "Yes"     ""        "Unclear"

#BLANKS - which ones? - 2015_Malaysia -> should be No as the previous question Was the assessment used to directly inform #management? was recorded as no connection 
data$Study.ID.1[which(data$Were.any.factors.indicators.linked.to.management.actions.=="")] 

data$Study.ID.1[which(data$Were.any.factors.indicators.linked.to.management.actions.=="Unclear")]
#DM_2016_EastAfrica
#Unclear because in the indicator selection criteria they mention relevance to management and managability as two criteria, but don't go on to specify what indicators or make substantial management reccomendations

data %<>%
  mutate(Were.any.factors.indicators.linked.to.management.actions.=Were.any.factors.indicators.linked.to.management.actions.   %>% 
                fct_recode(
                          `No`=""))



 ggplot(data, aes(x= factor(Were.any.factors.indicators.linked.to.management.actions.))) +
  geom_bar(aes(fill=Were.any.factors.indicators.linked.to.management.actions.))+
  theme_bw()+
  xlab('Were.any.factors.indicators.linked.to.management.actions.')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```


Were any thresholds (values) included to aid decision making?
```{r thresholds, eval=TRUE}

data$Were.any.thresholds..values..included.to.aid.decision.making. %>% unique()

# "No"   
# "0"   
# ""    
# "pre-European barium loads at 4.8+0.6x1012 and 3.5+0.2x1012 L/wk"
# "Yes - Algal tissue nutrient content data analyses revealed that all sites surveyed in this study displayed %N and N:P ratios above the globally-accepted median levels (1.8 %N and 30:1 Redfield ratio), indicating elevated nitrogen levels throughout the MPA"

#BLANKS - which ones?
data$Study.ID.1[which(data$Were.any.thresholds..values..included.to.aid.decision.making.=="")] #SA_2011_Indonesia

data$Study.ID.1[which(data$Were.any.thresholds..values..included.to.aid.decision.making.=="0")] #JH_2013_Malaysia

data %<>%
  mutate(Were.any.thresholds..values..included.to.aid.decision.making.=Were.any.thresholds..values..included.to.aid.decision.making.   %>% 
                fct_recode(
                          `No`="0",
                          `No` ="",
                          `Yes`="pre-European barium loads at 4.8+0.6x1012 and 3.5+0.2x1012 L/wk",
                         `Yes`= "Yes - Algal tissue nutrient content data analyses revealed that all sites surveyed in this study displayed %N and N:P ratios above the globally-accepted median levels (1.8 %N and 30:1 Redfield ratio), indicating elevated nitrogen levels throughout the MPA"
))



 ggplot(data, aes(x= factor(Were.any.thresholds..values..included.to.aid.decision.making.))) +
  geom_bar(aes(fill=Were.any.thresholds..values..included.to.aid.decision.making.))+
  theme_bw()+
  xlab('Were.any.thresholds.included.to.aid.decision.making.')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```


What management interventions were considered?
```{r mgt_interventions, eval=TRUE}
data$What.management.interventions.were.considered. %>% unique()

#only 2 assessments with problems:
# Bleaching monitoring and supporting recovery, Tourism outreach and stewardship - JM_2015_CNMI
# property development guidelines, zoning, terrestrial parks - JH_2017_Indonesia

commas<-Cs(JM_2015_CNMI,JH_2017_Indonesia)

#YMB_2022_GBR -> CoTS culling control of anchor damage - need to add a ; to split these two interventions


#Create a seperate dataset
mgt_interventions<-data %>% 
              mutate(mgt_interventions=`What.management.interventions.were.considered.`,
                     mgt_interventions=gsub("\n-",";",mgt_interventions),
                     mgt_interventions= case_when(Study.ID.1%in%commas~ gsub(",",";",mgt_interventions),
                                        Study.ID.1%in%"YMB_2022_GBR"~ gsub("culling","culling;",mgt_interventions),
                                        Study.ID.1%in%"DO_2011_Madagascar"~ gsub("systems - ","systems;",mgt_interventions),
                                                  TRUE ~ mgt_interventions))

str_split_fixed(mgt_interventions$mgt_interventions, ";",30) #nothing in cols 25-30, so can shorten to 24

mgt_interventions_split<-str_split_fixed(mgt_interventions$mgt_interventions, ";", 24)  %>% as.data.frame()
mgt_interventions_split$study<-mgt_interventions$Study.ID.1

#Change from wide to single, long column
data_long <- gather(mgt_interventions_split,study, values, V1:V24, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace


#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long %<>%  
              mutate(
                     values=gsub("Other: - ",";",values),
                     values=gsub("Other: -","",values),
                     values=gsub("Other:","",values),
                     values=gsub(";","",values),
                     values=gsub("- ","",values))


data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace

 
l<-data_long$values %>% unique() %>% sort() %>% as.data.frame()

#READ IN THE FILES AND IN DATA_LONG MATCH THE VALUES AND UPDATE WITH standardised_mgt_interventions_updated
mgt_interventions_standardised<-read.csv(file = "standardised_management_interventions_list_UPDATED.csv", header = T)

mgt_int_groups<-read.csv(file = "management_intervention_list_UPDATED.csv", header = T)

#add study column
data_long$study<-mgt_interventions_split$study


#CAN THEN SKIP THE STEP BELOW

#then assign Management_type from other file matching intervention with standardised_mgt_interventions_updated
#check all match
data_long$standard_interventions<-mgt_interventions_standardised$standardised_mgt_interventions_updated[match(data_long$values,mgt_interventions_standardised$raw_interventions)]

#some interventions missing because of being combined:
                          #`fishing gear restrictions`="restrictions on mesh sizes and species extraction" #GG_2009_Pemba
                          #restrictions on species extraction should be classified as fish catch restrictions, but this is missing in this assessment, so need to change

                          # `strategy`="limitation of fishing and boating damage" - control destructive fishing, moorings and no-anchor zones # DO_2008_Amirantes – both don’t exist so need to include both
                          # `strategy`="Maintain protection and manage effectively to reduce threats" - zoning and protection, reduce anthropogenic threats #add both #RS_2011_Wakatobi

#an easier way to do this would be to manually add fish catch restrictions to data_long

data_long %<>% add_row(study = "GG_2009_Pemba", values = "fish catch restrictions", standard_interventions="fish catch restrictions" ) %>% 
               add_row(study = "DO_2008_Amirantes", values = "moorings and no-anchor zones",standard_interventions ="moorings and no-anchor zones") %>% 
               add_row(study = "RS_2011_Wakatobi", values = "reduce anthropogenic threats", standard_interventions= "reduce anthropogenic threats")


data_long$mgt_group<-mgt_int_groups$Management_type[match(data_long$standard_interventions,mgt_int_groups$Intervention)]
#calculate the use (n_assessments) of each standardised_mgt_interventions_updated

#there are 2 rows to add:
# mgt_group -> Bleaching and disease management
# study -> JM_2015_CNMI,TP_2018_Indonesia
#actually JM_2015 already has a row for supporting recovery

data_long %<>%
  # add_row(study = "JM_2015_CNMI", 
  #         standard_interventions = "supporting recovery", 
  #         mgt_group = "Bleaching and disease management",
  #         values= "Bleaching monitoring and supporting recovery") %>%
  add_row(study = "TP_2018_Indonesia", 
          standard_interventions = "supporting recovery", 
          mgt_group = "Bleaching and disease management",
          values= "Bleaching monitoring and supporting recovery")

# GW_2019_PuertoRico - bleaching management - changed below
# standard_interventions- >supporting recovery

data_long %<>%
  mutate(
    standard_interventions = case_when(
      standard_interventions == "guidelines and best practices for coastal development" ~ "regulate coastal development",
      standard_interventions == "research-bleaching response" ~ "Bleaching monitoring",
      standard_interventions == "bleaching management" ~ "supporting recovery",
      standard_interventions %in% c("research - coral genetics to map sources of coral recruits", "research - spawning aggregations", "research - carrying capacity of divers") ~ "research",
      TRUE ~ standard_interventions
    ),
    mgt_group = ifelse(mgt_group == "Monitoring and Research", "Other", mgt_group)
  )



#then produce the plot showing:
#- mgt_type and the 3 -4 most common interventions
#- in brackets next to mgt_type can include how many assessments used these 

#remove blank rows and then find any studies where the same group is repeated more than once
data_long %<>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() #remove NAs


#number of assessments for each management_group
summary_table_mgt_int <- data_long %>% 
  group_by(mgt_group) %>% 
  summarise(n_assessments=study %>% unique() %>% length)  

g<-data_long %>% 
  group_by(standard_interventions,mgt_group) %>% 
  summarise(n=study %>% unique() %>% length)


# g$mgt_group<-mgt_int_groups$Management_type[match(g$standard_interventions,mgt_int_groups$Intervention)]
# #calculate the use (n_assessments) of each standardised_mgt_interventions_updated

g$n_assessments<-summary_table_mgt_int$n_assessments[match(g$mgt_group,summary_table_mgt_int$mgt_group)]


top_interventions <- g %>%
  group_by(mgt_group) %>%
  arrange(desc(n)) %>%
  slice_head(n = 3) %>%
  ungroup()

#rename the mgt_groups

#Zoning and management planning
#Fishery management
#Bleaching and disease management
#Tourism management
#Pollution and water quality management

top_interventions %<>%
  mutate(mgt_group=gsub("management","",mgt_group)%>% trimws()) %>% 
  mutate(mgt_group=gsub("Zoning and  planning","Area-based",mgt_group)) %>%
  mutate(mgt_group=gsub("Pollution and water quality","Water quality",mgt_group)) %>%
  mutate(mgt_group=gsub("Bleaching and disease","Bleaching",mgt_group)) %>% 
         mutate(
    standard_interventions = case_when(
      standard_interventions == "population control of nuisance/pest/invasive species" ~ "population control of pest/invasive species",
      standard_interventions == "protection and rehabilitation of coastal vegetation" ~ "protection/rehabilitation of coastal vegetation",
      standard_interventions == "Maintain protection and manage effectively to reduce threats" ~ "maintain protection and reduce threats",
      standard_interventions == "management of tourism activities" ~ "manage tourism",
      standard_interventions == "control of pollution from ocean-sources" ~ "control pollution - ocean-sources",
      TRUE ~ standard_interventions
    ))



ggplot(top_interventions, aes(x=fct_reorder(standard_interventions, n, .fun = mean), y=n, fill=mgt_group))+
    geom_rect(data = top_interventions, aes(xmin = -Inf, xmax = Inf, ymin = 0, ymax = n_assessments, fill = mgt_group), alpha = 0.2, inherit.aes = FALSE) +
  geom_bar(stat = "identity") +
  facet_wrap(~ mgt_group , scales = "free_y", ncol=2)+
  theme_bw()+
  xlab('')+
  ylab('Number of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text(size=20))+
  theme(panel.border = element_blank(),
        axis.text = element_text(size=20),
        axis.line = element_line(colour = "black"),
        text = element_text(size=20),
        strip.background = element_blank(),
        strip.text = element_text(size = 20, face = "bold"),
        panel.grid.major = element_blank(),  # remove major grid lines
        panel.grid.minor = element_blank(),
        plot.margin = margin(0,0,0,0))

ggsave("management_interventions.jpg",plot = last_plot(), width = 15.92, height = 10.61, dpi = 400)

#there are a lot of management strategies which are not specific actions/interventions e.g. eliminate breakage of coral colonies and selective, destructive, or overfishing. Tells you what to do but not how, so these can be ignored/removed/not considered

# data_long %<>%
#   mutate(values=values   %>% 
#                 fct_recode(
#                           `control destructive fishing`="eliminate breakage of coral colonies and selective, destructive, or overfishing,",
#                           `bleaching monitoring and management`="Bleaching monitoring and supporting recovery",
#                           `fishery management and regulation enforcement`="limiting unplanned expansion of settlement and migrant fisher bases in sheltered locations",
#                           `zoning and protection`="â€˜wise useâ€™ protection status to minimize damage and at  maximize benefits",
#                           `other`="avoid depletion and contamination of water resources",
#                           `education and awareness`="awareness to citizens and visitors",
#                           `monitoring and management of tourism activities`="boating and tourism restrictions",
#                           `land-based pollution/sedimentation`="careful guidance to avoid the potential negative impacts of increased sedimentation, pollution, and disease",
#                           `monitoring and management of tourism activities`="careful monitoring and management of tourism activities",
#                           `control destructive fishing`="clear buffer zones around NTZs of all destructive fishing gear and methods",
#                           `co-management/LMMA`="co-management with the involvement of local communities, the state and other stakeholders",
#                           `regulate coastal development`="coastal construction should be strictly regulated and follow the construction guidelines. The guidelines should become law",
#                           `fishery management and regulation enforcement`="control of resource extraction and protection of stock integrity and population dynamics (fishing regulations)",
#                           `wastewater management planned and implemented`="discharge of wastewater into the sea to be prohibited wastewater management to be planned and implemented",
#                           `code of conduct of best practice diving protocols`="draft and circulate a code of conduct of best practice diving protocols",
#                           `establish nutrient level regulations`="establishing nutrient level regulations/standards",
#                           `fishery management and regulation enforcement`="Fisheries management and law enforcement",
#                           `sustainably manage fishing of predatory fish`="fishing of predatory fish species be controlled and managed to a sustainable level",
#                           `full protection`="free of fishing pressure and other anthropogenic impacts",
#                           `regulate coastal development`="guidelines and best practices for coastal and foreshore development planning",
#                           `ICZM`="higher levels of protection to the beaches and reefs",
#                           `regulate coastal development`="improve management of development on the islands particularly around resilience sites",
#                           `NTAs`="increase the size and number of no-take areas",
#                           `increased stakeholder enforcement of MPA regulations`="increasing the role of dive boat operators and dive masters in enforcing the park rules and regulations among their guests",
#                           `moorings and no-anchor zones`="install moorings for dive and snorkel boats",
#                           `stakeholder engagement and empowerment`="Institutional strengthening of community groups and regulatory evaluation",
#                           `fish catch restrictions`="limit the capture and take of coral reef associated fishes that help maintain proper functioning of the reef community",
#                           `control destructive fishing`="limitation of fishing and boating damage",
#                           `zoning and protection`="Maintain protection and manage effectively to reduce threats",
#                           `bleaching monitoring and management`="Monitoring bleaching and recovery support",
#                           `monitoring runoff and pollution from land`="monitoring of runoff and pollution from land",
#                           `moorings and no-anchor zones`="moorings and noâ€anchor zones",
#                           `population control of nuisance/pest/invasive species`="population control of nuisance species and pest species including certain damselfishes",
#                           `population control of nuisance/pest/invasive species`="populations of Trididemnum and Lobophora are closely monitored and the factors contributing to the unnatural abundance of these coral overgrowing organisms should be studied and then eliminated",
#                           `waste and sewage treatment/management`="programme of septic tank desludging and maintenance",
#                           `protection and rehabilitation of coastal vegetation`="protection and rehabilitation of coastal vegetation (e.g., through mangrove planting)",
#                           `monitoring and management of tourism activities`="reallocating and restricting tourist activities",
#                           `population control of nuisance/pest/invasive species`="removal of benthic invertebrates that are overgrowing/bioeroding corals such as certain soft corals, colonial anemones and bioeroding sponges",
#                           `removal of coral bioeroders and predators`="removal of bioeroding sea urchins (such as at Ampisandava)",
#                           `removal of coral bioeroders and predators`="removal of crown of thorns and Drupella snails during population explosions",
#                           `fishing gear restrictions`="restrictions on mesh sizes and species extraction",
#                           `species conservation plans`="Species conservation plans. Flagship species for protection (e.g. sharks, sea turtles, Napoleon wrasse, Bumphead parrotfish and large groupers)",
#                           `protection and rehabilitation of coastal vegetation`="strand and littoral forest vegetation to be maintained intact so far as possible",
#                           `control of pollution from ocean-sources`="Strict controls on utilization and pollution from boats",
#                           `outreach and stewardship`="Tourism outreach and stewardship",
#                           `control destructive fishing`="Unsustainable coral reef fisheries and use of destructive fisheries gear types should be eliminated",
#                           `prohibit use of fins and gloves by tourists`="use of gloves by snorkellers and divers to be prohibited",
#                           `watershed management and protection`="watershed management and protection in particular the mangroves of the Delta,",
#                           `monitoring`="Establish a Coral Reef Monitoring Program",
#                           `removal of coral bioeroders and predators`="CoTS culling",
#                           `regulate coastal development`="all development along the coast to be well set back from the shoreline",
#                           `monitoring and management of tourism activities`="alleviating physical damage from divers",
#                           `moorings and no-anchor zones`="areas without boat anchors",
#                           `education and awareness`="awareness programs for users of the park",
#                           `moorings and no-anchor zones`="ban anchoring in sensitive areas",
#                           `moorings and no-anchor zones`="control of anchor damage",
#                           `banning use of fins by snorkellers`="banning use of fins by snorkellers",
#                           `bleaching monitoring and management`="bleaching monitoring",
#                           `buffer zones around NTAs`="buffer zone reserve",
#                           `buffer zones around NTAs`="Buffer zones where limited fishing activity is allowed around these no-take zones should also be established",
#                           `moorings and no-anchor zones`="build boat moorings",
#                           `moorings and no-anchor zones`="buoys/markers (no-anchoring)",
#                           `control destructive fishing`="cessation of blast fishing",
#                           `algae removal`="clearing of macroalgae/cyanobacteria",
#                           `regulate coastal development`="coastal development to have comprehensive environmental management plan that includes wastewater treatment",
#                           `population control of nuisance/pest/invasive species`="conduct targeted invasive species removals",
#                           `research - spawning aggregations`="confirm if fish spawning aggregation",
#                           `control destructive fishing`="Control destructive/ dynamite fishing",
#                           `control destructive fishing`="control of the use of hazardous chemicals for fishing",
#                           `removal of coral bioeroders and predators`="COTs removal",
#                           `removal of coral bioeroders and predators`="crown-of-thorns starfish monitoring with possible removal programmes",
#                           `artificial reef installation`="deployment of artificial substrates",
#                           `disease management`="disease management",
#                           `research - carrying capacity of divers`="diving should be limited pending the recommendations of a carrying capacity study",
#                           `waste and sewage treatment/management`="drainage arrangement",
#                           `zoning and protection`="enhance fishing in sites with difficulties in accessibility to ease pressure in overfished sites",
#                           `NTAs`="Establish a NTA",
#                           `monitoring`="Establish a simple but effective monitoring programme",
#                           `zoning and protection`="establish management zones based on representative criteria",
#                           `full protection`="establishing as a strictly protected area (no activities)",
#                           `shading`="field shading to protect corals during bleaching",
#                           `fishery management and regulation enforcement`="fishery management",
#                           `herbivore protection`="fishing regulations that embrace the management of grazing process",
#                           `research-bleaching response`="future surveys during upcoming bleaching events to explore the sensitivity of coral species to bleaching",
#                           `waste and sewage treatment/management`="household waste treatment",
#                           # `strategy`="implement management plans effectively",
#                           `wastewater management planned and implemented`="Improve Coastal Zone Management -discharge of water from desalinization plants",
#                           `improve regulation enforcement`="Improve law enforcement",
#                           `monitoring`="improve monitoring programmes",
#                           # ``="improve regulation enforcement",
#                           `monitoring`="include basic nutrient level assessments in annual monitoring protocols",
#                           `fishery management and regulation enforcement`="increased enforcement of fish regulations",
#                           `waste and sewage treatment/management`="invest in appropriate sewage treatment facilities to improve water quality",
#                           `waste and sewage treatment/management`="investment in waste management infrastructure",
#                           `control destructive fishing`="limitation of future destructive activities",
#                           `herbivore protection`="Maintaining or boosting the population of grazers",
#                           `monitoring and management of tourism activities`="Manage for tourism",
#                           `herbivore protection`="Manage over fishing (especially of herbivores)-",
#                           `manage Water quality`="Manage Water quality",
#                           `control of pollution from ocean-sources`="marine environmental pollution control",
#                           `outreach and stewardship`="marine resource stewardship",
#                           # ``="mats to be laid along all beach access points",
#                           `moorings and no-anchor zones`="measures that can restrict or prohibit reef physical damage caused by anchoring",
#                           `herbivore protection`="mitigate both local harvest of the herbivorous reef fish e.g. parrotfish",
#                           `removal of coral bioeroders and predators`="Monitor & remove crown of thorns starfishes",
#                           `monitoring`="Monitor Fishing Pressure",
#                           `monitoring`="monitoring fish populations",
#                           `monitoring`="monitoring of runoff and pollution from land",
#                           `monitoring`="monitoring to track recovery",
#                           `fishery management and regulation enforcement`="nationwide inshore fisheries management plan",
#                           `herbivore protection`="parrotfish protection (cessation of fishing)",
#                           `moorings and no-anchor zones`="policy of no anchoring by dive boats",
#                           `moorings and no-anchor zones`="prevent anchor damage",
#                           # ``="preventing unregulated fishing",
#                           `waste and sewage treatment/management`="programme of septic tank desludging and maintenance",
#                           `research`="promote research on coral genetics to map sources of coral recruits",
#                           `regulate coastal development`="property development guidelines",
#                           `artificial reef installation`="reefballs as artificial substrate in areas dominated by unconsolidated rubble",
#                           `protection and rehabilitation of coastal vegetation`="reforestation",
#                           `protection and rehabilitation of coastal vegetation`="forest conservation",
#                           # ``="regulation of catch size limits",
#                           `herbivore protection`="regulation of herbivore fisheries",
#                           `regulate coastal development`="Regulation of the construction of hard structures",
#                           # ``="restrict recreational diving activities",
#                           `control destructive fishing`="restrictions of destructive fishing gear such as beach seining with small mesh sizes or dynamite fishing should be controlled or banned",
#                           `NTAs`="revision of the zoning plan to designate this as a no-take area",
#                           `shading`="shade or other cooling action",
#                           `artificial reef installation`="shorter-term rehabilitation efforts may be necessary to assist coral recover e.g. substrate consolidation",
#                           `algae removal`="small scale management trials e.g. of clearing macroalgae/cyanobacteria",
#                           # ``="stocking fish",
#                           `tourism development`="temporarily set as a tourism zone",
#                           # ``="terrestrial parks",
#                           `outreach and stewardship`="tourist outreach",
#                           `watershed management and protection`="watershed management to reduce sediment impacts on marine systems",
#                           `zoning and protection`="zoning",
#                           `bleaching monitoring and management`="bleaching management",
#                           `co-management/LMMA`="LMMA",
#                           `zoning and protection`="Prioritize Conservation",
#                           `zoning and protection`="reef protection",
#                           `fishery management and regulation enforcement`="Fishery management and enforcement",
#                           `co-management/LMMA`="LMMAs",
#                           `marine debris cleanup`="marine debris removal",
#                           `moorings and no-anchor zones`="moorings and no-anchoring areas",
#                           `fish catch restrictions`="size regulations", #Maynard 2015 - refers to size of fish
#                           `fish catch restrictions`="regulation of catch size limits",
#                           `monitoring and management of tourism activities`="restrict recreational diving activities",
#                           `prohibit use of fins and gloves by tourists`="banning use of fins by snorkellers",
#                           `protection and rehabilitation of coastal vegetation`="riparian restoration",
#                           `shading`="shading or other cooling measures",
#                           `stocking fish`="fish stocking",
#                           `waste and sewage treatment/management`="sewage treatment upgrades",
#                           `algae removal`="Algae removal",
#                           `artificial reef installation`="Artificial reef installation",
#                           `fish catch restrictions`="Fish catch restrictions",
#                           `fishing gear restrictions`="Fishing gear restrictions",
#                           `bleaching monitoring and management`="Bleaching monitoring"))
# 
# 
# k<-data_long$values %>% as.character %>%  unique() %>% sort() %>% as.data.frame()
# 
# 
# #trying to find out the frequency of use of each mgt intervention
# #each intervention should only reflect once per assessment
# #need to check this
# 
# 
# #add study column
# data_long$study<-mgt_interventions_split$study
# 
# #some interventions missing because of being combined:
#                           #`fishing gear restrictions`="restrictions on mesh sizes and species extraction" #GG_2009_Pemba
#                           #restrictions on species extraction should be classified as fish catch restrictions, but this is missing in this assessment, so need to change
# 
#                           # `strategy`="limitation of fishing and boating damage" - control destructive fishing, moorings and no-anchor zones # DO_2008_Amirantes – both don’t exist so need to include both
#                           # `strategy`="Maintain protection and manage effectively to reduce threats" - zoning and protection, reduce anthropogenic threats #add both #RS_2011_Wakatobi
# 
# #an easier way to do this would be to manually add fish catch restrictions to data_long
# 
# data_long %<>% add_row(study = "GG_2009_Pemba", values = "fish catch restrictions") %>% 
#                add_row(study = "DO_2008_Amirantes", values = "moorings and no-anchor zones") %>% 
#                add_row(study = "RS_2011_Wakatobi", values = "reduce anthropogenic threats")
# 
# #remove blank rows and then find any studies where the same group is repeated more than once
# data_long %<>%  #
#   mutate_all(na_if,"") %>%  #make blanks into NAs
#   na.omit() #remove NAs
# 
# 
# p<-data_long %>% 
#   group_by(study,values) %>% 
#   summarise(n=length(values)) #check what studies may have repeated groups
# 
# which(p$n>1) %>%  length() #15 possible studies with duplication of interventions
# 
# #manually inspect
# #DO_2009_NosyHara - Algae removal, yes, change
# #`fish catch restrictions`="size regulations", #Maynard 2015 - refers to size of fish
# #NO ISSUES, ALL DUPLICATIONS ARE FINE AND SHOULD ONLY BE CONSIDERED ONCE
# 
# #need to look for overlap with MPAs and NTAs 
# p %>% 
#   group_by(study) %>% 
#   filter(any(values == "MPA/MPA network") & any(values == "NTAs")) %>% 
#   ungroup() %>% 
#   pull(study) %>% 
#   unique()
# #[1] "CL_2013_Mexico" (revision of the zoning plan to designate this as a no-take area)  "RS_2014_SavuSea" (increase the size and number of no-take areas)
# 
# #might be worth going through the MPAs (19 studies) to see if mention of NTAs or combine the two into MPA/MPA network/NTA
# 
# data_plot<-p %>% 
#         group_by(values) %>% #
#     summarise(n=length(values))  #frequency count of responses


```

```{r intervention_table, results='asis', eval=FALSE}
#Output table
kable(data_plot, caption = "Managment interventions", 
      row.names = FALSE,
      col.names = c("Management intervention","No. of studies")) %>% 
  kable_styling(full_width = F) 


```



How many indicators were considered to have management potential?

```{r mgt_potential_indicators, eval=TRUE}
data$How.many.indicators.were.considered.to.have.management.potential. %>% unique() #26

#split into two columns, one with the number of indicators and one with the list of indicators

#Create a seperate dataset
mgt_potential<-data %>% 
              mutate(mgt_potential=`How.many.indicators.were.considered.to.have.management.potential.`)
                    

o<-str_split_fixed(mgt_potential$mgt_potential, "\\(",30) #nothing in cols 24-30, so can shorten to 23


mgt_potential_split<-str_split_fixed(mgt_potential$mgt_potential, "\\(",5)  %>% as.data.frame()
mgt_potential_split$study<-mgt_potential$Study.ID.1

mgt_potential_split$indicators<-regmatches(mgt_potential$mgt_potential, gregexpr("(?<=\\().*?(?=\\))", mgt_potential$mgt_potential, perl=T))

mgt_potential_split %<>% 
            rename('number'="V1") %>% 
            select(number, study, indicators)

#studies to change number to 0 
# NTL_2019_Vietnam
# PM_2014_Caribbean
# 
# 
# #all blanks to 0
# 
# #other changes
# AMN_2019_GBR - 1
# JM_2010_GBR - 4
# DM_2016_EastAfrica - unclear
# GG_2009_Pemba - unclear
# 
# JM_2010_GBR - number to indicators

#Check for studies where a number was recorded but no indicators listed
mgt_potential_split %>%
  filter(!number %in% "0") %>%
  filter(indicators %in% 'character(0)') %>% 
  pull(study) 
# "GG_2009_Pemba"  DM_2016_EastAfrica - unclear
#"MP_2015_Riung" - suitable substrate, herbivore biomass, physical human impact, mobile cover
#"BS_2018_Samoa" - sedimentation, pollution, fishing pressure
#"JM_2015_CNMI" - resilience potential (overall), land-based pollution, wave exposure (fishing access), herbivore biomass, bleaching resistance, coral diversity, coral cover, fish species diversity
#"CL_2013_Mexico" -   ‘Free from Fishing Pressure’, ‘Free from Contamination/Pollution (%N and N:P), ‘Free from Land-based 15d Anthropogenic Impacts (N), ‘Herbivore Biomass’, ‘Free from Anthropogenic Physical Impacts (Tourism Intensity)’, ‘Abundance of Invasive Species (Pterois volitans)  


mgt_potential_split %<>%
  mutate(indicators = indicators %>% as.character(),
  indicators = case_when(study %in% "JM_2010_GBR" ~ "fishing pressure; water pollution; sedimentation; anthropogenic physical impacts",
                         study %in% "MP_2015_Riung" ~ "suitable substrate; herbivore biomass; physical human impact; mobile cover",
                         study %in% "BS_2018_Samoa" ~ "sedimentation; pollution; fishing pressure",
                         study %in% "JM_2015_CNMI" ~ "resilience potential; land-based pollution; wave exposure (fishing access); herbivore biomass; bleaching resistance; coral diversity; coral cover; fish species diversity",
                         study %in% "CL_2013_Mexico" ~ "Free from Fishing Pressure; Free from Contamination/Pollution (%N and N:P); Free from Land-based Anthropogenic Impacts (N); Herbivore Biomass; Free from Anthropogenic Physical Impacts (Tourism Intensity); Abundance of Invasive Species (Pterois volitans)",
                         TRUE ~indicators),
    number=case_when(study %in% "AMN_2019_GBR" ~ "1",
                          study %in% "JM_2010_GBR" ~"4",
                          study %in% "DM_2016_EastAfrica" ~ "unclear",
                          study %in% "GG_2009_Pemba" ~ "unclear",
                          study %in% "NTL_2019_Vietnam" ~ "0",
                          study %in% "PM_2014_Caribbean" ~ "0",
                          number %in% "" ~ "0",
                          TRUE ~ number)
         )
  
#find out the method for those where number!=0
not_zero<-mgt_potential_split %>%
  filter(!number %in% "0") %>% 
  pull(study) 

#find out if all those assessments with mgt potential indicators (number and indicators) also were all Yes for Were.any.factors.indicators.linked.to.management.actions.
data %>% 
  filter(Study.ID.1 %in% not_zero) %>% 
  count(Were.any.factors.indicators.linked.to.management.actions.)

# No	5			
# Unclear	1			
# Yes	16

#what are the 5 No
data %>% 
  filter(Study.ID.1 %in% not_zero) %>% 
  filter(Were.any.factors.indicators.linked.to.management.actions.=="No") %>% 
  pull(Study.ID.1)
# "TA_2008_Philippines" "RS_2010_Mozambique"  "RS_2011_Palau"       "AMN_2019_GBR"        "BS_2018_Samoa" 
#these are studies which were listed to have no indicators linked to mgt actions but then indicators were listed under managment potential indicators


#frequency of responses
h<-data %>% 
  filter(Study.ID.1 %in% not_zero) %>% 
  count(inform_mgt)

#out of 22, descriptive - 4 (see below), general connection - 1 (DM_2016_EastAfrica) -unlcear indicators

data %>% 
  filter(Study.ID.1 %in% not_zero) %>% 
  filter(inform_mgt %in% "descriptive") %>% 
  distinct(Study.ID.1)
# TA_2008_Philippines	- 2 indicators listed, check methods 			
# GG_2009_Pemba		- unlcear indicators		
# MP_2015_Riung	 - 4 indicators but none listed, check -suitable substrate can be enhanced by deployment of artificial substrates, herbivore biomass through mitigate local harvest of the herbivorous reef fish e.g. parrotfish, and physical damage by limitation of future destructive activities, mobile cover (%)by shorter-term rehabilitation efforts may be necessary to assist coral recover
# MC_2014_Thailand - 15 indicators listed, check? cabral had a grouping for management indicators. should this be an analytical approach for mgt prioritisation since they calculate a mangement index?

data %>% 
  filter(Study.ID.1 %in% not_zero) %>%
  filter(inform_mgt %in% "descriptive") %>%
  count(What.methods.were.used.to.prioritise.sites.for.management.action.)
#for all descriptive, the method is Interpretation of overall/individual indicator results

  
#split dataset
mgt_potential_split %<>%  
              mutate(
                     indicators=gsub(",",";",indicators))

o<-str_split_fixed(mgt_potential_split$indicators, ";",15) %>% as.data.frame() #nothing in cols 24-30, so can shorten to 23

#Change from wide to single, long column
data_long <- gather(o,study, values, V1:V15, factor_key=TRUE)

#2 cleaning steps: 1. remove leading whitespace, 2. remove leading whitespace
#remove - at start of some strings
data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace


#since there are no blanks or individual/unique responses just the 6 options for responses, then no need to go through the usual steps, just remove all blanks from the long dataset and count frequency of occurence

data_long %<>%  
              mutate(
                     values=gsub("character(0)",";",values))


data_long$values<-sub("^\\s+", "", data_long$values) #removesleading whitespace
data_long$values<- sub("\\s+$", "", data_long$values) #removes trailing whitespace
data_long$values<- gsub("(\\D)(\\D+)", "\\U\\1\\L\\2", data_long$values, perl = TRUE) #capitalise sentence case

 
l<-data_long$values %>% unique() %>% sort() %>% as.data.frame()




#there are a lot of management strategies which are not specific actions/interventions e.g. eliminate breakage of coral colonies and selective, destructive, or overfishing. Tells you what to do but not how, so these can be ignored/removed/not considered

data_long %<>%
  mutate(values=values   %>% 
                fct_recode(
                  `Local threat`='"anthropogenic stress")',
                  `Local threat`='Integrated local threat',
                   `Pollution-solid`='"solid"',
                  `Invasive species abundance`="Abundance of invasive species (pterois volitans)",
                  # ``="Algae cover",
                  `Anthropogenic physical impacts`="Anthropogenic physical impacts'",
                  `Anthropogenic physical impacts`="Physical human impact",
                  `Anthropogenic physical impacts`="Physical human impact",
                  `Anthropogenic physical impacts`="Are some of the physical impacts to corals caused by human activities?",
                  # ``="Bleaching projections",
                  # ``="Bleaching resistance",
                  `Destructive fishing`='C("destructive fishing',
                  `Destructive fishing`="Are destructive fishing practices being used?",
                  # ``="COTs presence",
                  # ``="Feasibility of managing destructive fishing practices",
                  # ``="Feasibility of managing fishing pressure intense?",
                  # ``="Feasibility of managing fishing pressure on herbivores?",
                  # ``="Feasibility of managing other extractive practices at the site",
                  # ``="Feasibility of managing physical impacts to corals caused by human activities?",
                  # ``="Feasibility of managing pollution from run-off at the site?",
                  # ``="Feasibility of managing sedimentation at the site enhanced by human activity?",
                  `Herbivore abundance`="Herbivores",
                  `Herbivore abundance`="Abundance of herbivores",
                  `Fishing pressure`="Is fishing pressure intense?",
                  `Sedimentation`="Is sedimentation at the site enhanced by human activity?",
                  `Fishing pressure - herbivores`="Is there fishing pressure on herbivores?",
                  `Pollution-chemical`='Pollution (chemical"',
                  `Nutrient input`="Free from contamination/pollution (%n and n:p)",
                  `Land-based sources of pollution`="To what extent is pollution from run-off a driver of water quality at the site?",
                  `Land-based sources of pollution`="Source of pollution on land",
                  `Land-based sources of pollution`="Water pollution",
                  `Land-based sources of pollution`="Free from land-based anthropogenic impacts (n)",
                  `Land-based sources of pollution`="Land-based pollution",
                  `COTs presence`="Cots presence",
                  `Outside MPA`="Outside mpa",
                  `Fishing access`="Wave exposure (fishing access)",
                  `Fishing pressure`="Total fishing",
                  `Fishing pressure`="Free from fishing pressure",
                  `Anthropogenic physical impacts`="Physical impacts",
                  `Anthropogenic physical impacts`="Physical damage",
                  `Anthropogenic physical impacts`="Free from anthropogenic physical impacts (tourism intensity)",
                  `Coastal development`="Nearshore development",
                  `Nutrient input`="Total effluent",
                  `Sedimentation`="Riverine-plume frequency",
                  `Fish species diversity`="Fish species richness")
  )
                   

          
l1<-data_long$values %>% as.character %>% unique() %>% sort() %>% as.data.frame()

#add study column - this can then be used to look for duplication (multiple representation of same group per assessment) later
data_long$study2<-mgt_potential_split$study


#When we group things together e.g. positive and negative associates, then we are artifically creating duplication, where it will be counted twice for one assessment if both indicators are used

#remove blank rows and then find any studies where the same group is repeated more than once
data_long %<>%  #
  mutate_all(na_if,"") %>%  #make blanks into NAs
  na.omit() %>%  #remove NAs
  filter(!values=="Character(0)") %>% 
  filter(!values=="Model")

p<-data_long %>% 
  group_by(study2,values) %>% 
  summarise(n=length(values)) #check what studies may have repeated groups
#TP_2018_Indonesia - Fishing access


#will just need to create a new matrix with the method and frequency
data_plot<-data_long %>%
        group_by(values) %>% 
        count(values)  #frequency count of responses



kable(data_plot, caption = "Frequency management potential indicators", 
      row.names = FALSE) %>% 
  kable_styling(full_width = F)


```

Check to see if all the indicators are selected. What type of method was used to inform management for thsese assessments? were they all analytical?

What indicators were linked to management and what actions did they link to?

```{r mgt_indicators, eval=TRUE, results='asis'}

#different outputs
# how often each indicator is used for each intervention

# how often each indicator is used overall (across all interventions)
#- standardised indicators

# what are the different indicators used for each intervention

# what are the different indicators used overall
#- standardised indicators

# what are the different/unique indicator combinations used for each intervention 
#- standardised indicator combinations

#maybe a more interesting question is about what indicators inform the most different interventions
#- indicators and the list and number of actions they inform
#can also get a full list of indicators used across but not how often/how many assessments used them

#what is the most common indicator is not as useful

#Create two matrices:
#1. for each mgt intervention - list of indicators used, and different combinations of indicators from different assessments
#2. for each indicator - the different interventions it was used for

#create a matrix with actions and related indicators and study ID

mgt_actions<-data[,c(5,45,49,53,57,61,65)]
mgt_indicators<-data[,c(5,44,48,52,56,60,64)]

#delete blanks in Indicator.1.Action.s.
#wide to long

#work on actions and indicators separately 
  
data_long_action <- gather(mgt_actions, number, action, Indicator.1.Action.s.:Indicator.6.Action.s., factor_key=TRUE)
data_long_mgt <- gather(mgt_indicators, number, indicators, Indicator.1.Indicator:Indicator.6.Indicator, factor_key=TRUE)

data_long <-cbind(data_long_action,data_long_mgt)  

data_long <- data_long[, !duplicated(colnames(data_long))]

#remove all blank rows

data_long <- data_long[-which(data_long$action==""),]

#clean up columns
data_long$action<-sub("^\\s+", "", data_long$action) #removesleading whitespace
data_long$action<- sub("\\s+$", "", data_long$action) #removes trailing whitespace
data_long$action<- gsub('^\\-|\\-$', '', data_long$action) #removes leading -
data_long$action<-tolower(data_long$action) #converts all captial to lower


data_long$indicators<-sub("^\\s+", "", data_long$indicators) #removesleading whitespace
data_long$indicators<- sub("\\s+$", "", data_long$indicators) #removes trailing whitespace
data_long$indicators<- gsub('^\\-|\\-$', '', data_long$indicators) #removes leading -
data_long$indicators<-tolower(data_long$indicators) #converts all captial to lower



#The following steps relate to finding potential issues in the indicators and interventions and correcting them
#The full list of issues and solutions implemented is detailed in 'Review and corrections to data extraction Jan 23'

#ideally should be the same list as the mgt_potential_indicators

studies<-data_long$Study.ID.1 %>% unique() #22 assessments

#can find out the response from 'were any factors/indicators linked to management actions?'
#how many are yes
data %>% 
  filter(Were.any.factors.indicators.linked.to.management.actions.=="Yes") %>% 
  pull(Study.ID.1) #22 assessments

#SA_2011_Indonesia, RS_2011_Wakatobi not in 'studies' object, therefore have been specified to have indicators linked to management actions but no indicators or actions listed in indicator-action matrix

#RS_2011_Wakatobi provides very generic mgt strategies not actions e.g. important to maintain protection and to manage effectively to maintain low level of anthropogenic stress


data %>% 
  filter(Study.ID.1 %in% studies) %>% 
  # pull(Were.any.factors.indicators.linked.to.management.actions.) %>% 
  filter(Were.any.factors.indicators.linked.to.management.actions.=="No") %>% 
  pull(Study.ID.1)

#Assessments with No response - [1] "AMN_2019_GBR" (should be yes, riverine plume frequency linked to water catchment mgt in matrix)  "BS_2018_Samoa" (nothing specifically for actions in indicator matrix)

#assessments not in this list but in mgt_potential_indicators

# TA_2008_Philippines - - awareness programs for users of the park
# - free of fishing pressure and other anthropogenic impacts
# -increasing the role of dive boat operators and dive masters in enforcing the park rules and regulations among their guests -  anthropogenic physical impacts
# RS_2010_Mozambique - No management actions listed, no updates to be made

# RS_2011_Palau - The only thing they did not do was specify interventions but they did make statements like ‘increase management effort and decrease level of anthropogenic stress’, ‘capacity and effort to manage anthropogenic threats needs to be improved to increase resilience’, ‘maintain values of this important reef type to representation and connectivity in the Palau protected area network’, ‘It is a low value site that should either be replaced or supplemented by one in the proximity that has higher resilience and recovery attributes’. no mgt actions were specified. The groupings were used instead of individual indicators mainly. Same as Wakatobi

# RS_2011_Wakatobi - provides very generic mgt strategies not actions e.g. important to maintain protection and to manage effectively to maintain low level of anthropogenic stress. Not sure if these qualify as actions and they also link to grouped indices not specific indicators. 

# DM_2016_EastAfrica -The largest human influences on coral reefs that are potentially manageable on a local scale are fishing, pollution, and sedimentation. – update the How many indicators were considered to have management potential? From Unclear to 3,
#Can also add 1 action-indicator to matrix

# Assessment in this list but not in mgt_potential_indicators

# DO_2011_Mafia - factors were important in selecting priority areas but factors were not stated as being explicitly manageable. Also the indicators are used to select actions rather than the other way round i.e. actions are not stated to necessarily affect indicators and therefore can't say indicators are managable. 

# MS_2011_Metundo - can update indicator-action matrix, MPA/NTA should replace 'reduce fishing pressure' for acr cover
                    #total fish abundance could be a manageable indicator/factor - low densities of reef fishes is of concern ...it is highly recommended that a zoning system of fisheries management including a network of no-take zones (NTZs) is considered

# DO_2014_Myanmar -add Buffer zones to mgt interventions. Fair enough to have mgt_potntial indicators set at 0, but they seem to indicate that coral disease and bio-eroding sea urchins can be managed hence why they suggest managing overfishing and localised impacts

# DO_2011_Madagascar - only if want to consider some listed in action-intervention matrix

# NE_2015_TalimBay -Regulation of the construction of hard structures, as well as the protection and rehabilitation of coastal vegetation (e.g., through mangrove planting) should help reduce sedimentation. Another possible mitigation measure is the reduction of fishing pressure, which will allow for the recovery reef fishes stocks, especially those of herbivores
#so from this 2 managable indicators are sedimentation and herbivore abundance
#You could also say that you need to implement these actions where sedimentation is high or herbivore ab is low - two ways of saying the same thing (inverese)
#Need to consider that the information provided is actually about what actions can impact processes on reefs e.g. sedimentation, whereas the matrix is to list the indicators used to select specific actions

#would need to consider counting the same indicators more than once for the same assessment - only count once



#identify those assessments where I swaped the actions and indicators (corrected @ source where relevant)
# JM_2015_CNMI
# NE_2015_TalimBay
# CL_2013_Mexico
# DO_2014_Myanmar
# EM_2012_Micronesia
# MP_2015_Riung


#1. for each mgt intervention - list of indicators used

#gibbs and west has two management actions in one row as had run out of space - bleaching management; disease management - need to separate

# Subset the data frame to only include the specific row

row_to_split <- data_long[data_long$Study.ID.1 == "GW_2019_PuertoRico" & data_long$number == "Indicator.6.Action.s.",]

row_split2 <- row_to_split %>%  
                        summarise(Study.ID.1 = rep(Study.ID.1, 2),
                         number = c("Indicator.6.Action.s.", "Indicator.7.Action.s."),
                         action = unlist(strsplit(as.character(action), ";")),
                         indicators = unlist(strsplit(as.character(indicators), "/"))) %>% data.frame()

#remove the original problem row from data_long
data_long <- data_long %>% 
  filter(!(Study.ID.1 == "GW_2019_PuertoRico" & number == "Indicator.6.Action.s.")) %>% 
  bind_rows(row_split2)

#Standardise the actions across all assessments - group common interventions under the same name
k<-data_long$action %>% unique() %>% sort() %>% as.data.frame()



data_long %<>%
  mutate(action2=action %>% 
                fct_recode(
                           `bleaching monitoring`="bleaching management",
                           `bleaching monitoring`="bleaching monitoring and supporting recovery",
                           `bleaching monitoring`="surveys during upcoming bleaching events to explore the sensitivity of coral species to bleaching",
                           `buffer zone`="buffer zone reserve",
                           `buffer zone`="buffer zones for application of fishing gear",
                           `coastal development`="coastal development",
                           `coastal development`="manage nearby development",
                           `coastal development`="regulation of the construction of hard structures",
                           `conservation`="conservation",
                           `conservation`="conservation - institutional strengthening of community groups and regulatory evaluation",
                           `conservation`="conservation e.g. mpas",
                           `conservation`="prioritize conservation",
                           `disease management`="\ndisease management",
                           `full protection`="full protection",
                           `MPA/NTA`="priority protection",
                           `MPA/NTA`="maintain protection",
                           `MPA/NTA`="reef protection",
                           `MPA/NTA`="protecting this reef and improving management would maintain resilience",
                           `monitoring`="control site in the wakatobi monitoring program",
                           `COTs monitoring and removal`="crown-of-thorns starfish monitoring and removal programmes",
                           `COTs monitoring and removal`="monitor & remove crown of thorns starfishes",
                           `fishery management`="fisheries management",
                           `fishery management`="fishery management",
                           `fishery management`="fishery management and enforcement",
                           `fishery management`="fishery management and enforcement - improve law enforcement, temporary closure, regulation of catch size limits, making moorings and areas without boat anchors, and stocking fish, and marine debris cleanup",
                           `fishery management`="targeted actions to reduce fishing pressure",
                           `management of anthropogenic threats`="improve management of anthropogenic threats",
                           `management of anthropogenic threats`="increase management effort and decrease level of anthropogenic stress",
                           `management of anthropogenic threats`="increase management to reduce threats",
                           `management of anthropogenic threats`="capacity and effort to manage anthropogenic threats needs to be improved",
                           `management of anthropogenic threats`="maintain low level of anthropogenic stress",
                           `management of anthropogenic threats`="maintain protection and manage effectively to maintain low level of anthropogenic stress",
                           `management of anthropogenic threats`="management of localized impacts",
                           `land-based pollution and sedimentation management`="integrated management mechanisms to address inland sources of pollution and sedimentation",
                           `land-based pollution and sedimentation management`="inland activities that cause nutrient of sediment pollution",
                           `land-based pollution and sedimentation management`="reduce sedimentation",
                           `land-based pollution and sedimentation management`="land-based pollution management",
                           `land-based pollution and sedimentation management`="land-based source pollution reduction",
                           `land-based pollution and sedimentation management`="land-based sources of pollution reduction",
                           `land-based pollution and sedimentation management`="land-based sources of pollution reduction - reforestation, drainage arrangement, control of other erosion practices, household waste treatment, control of the use of hazardous chemicals to catch fish",
                            `watershed management and protection`="land use practices",
                           `restrictions of destructive fishing`="addressing the threat of migrant fishing and the use of high-efficiency gears such as ring nets",
                           `restrictions of destructive fishing`="limitation of destructive activities, domestic waste management and treatment",
                           `restrictions of destructive fishing`="restrictions of destructive fishing gear, mesh sizes and species extraction",
                           `fishery management`="manage over fishing (especially of herbivores)",
                           `fishery management`="reduction of fishing pressure",
                           # `management to reduce overfishing`="management to reduce overfishing",
                           `herbivorous fish regulation`="managing the extraction of herbivorous reef fish",
                           `herbivorous fish regulation`="regulation of herbivore fisheries",
                           `monitoring`="monitor fishing pressure",
                           `MPA/NTA`="mpa",
                           `MPA/NTA`="mpa network",
                           `MPA/NTA`="mpa/nta",
                           `MPA/NTA`="no-take zone",
                           `MPA/NTA`="nta",
                           `MPA/NTA`="considered for protection (mpa), improving management effectiveness",
                           `measures to reduce damage caused by anchoring`="reef protection markers (rpms) no-anchoring areas",
                           `measures to reduce damage caused by anchoring`="measures to prohibit reef physical damage caused by anchoring",
                           `restoration`="coral restoration",
                           `restoration`="reef restoration/coral translocation",
                           `restoration`="restoration - coral transplantation, artificial reef installation, translocation species",
                           `restoration`="reedballs to provide artificial substrate",
                           # ``="manage water quality",
                           `restoration`="shorter-term rehabilitation efforts may be necessary to assist coral recover e.g. substrate consolidation",
                           # ``="spatial conservation planning",
                           `restoration`="supporting the recovery of reefs",
                           # ``="target lionfish removal",
                           `tourism zone`="temporary tourism zone",
                           `tourism outreach and stewardship`="tourism outreach",
                           `tourism outreach and stewardship`="increasing the role of dive boat operators and dive masters in enforcing the park rules and regulations among their guests",
                           # ``="tourism outreach and stewardship",
                           `tourism outreach and stewardship`="marine resource stewardship",
                           `tourism outreach and stewardship`="tourism outreach and stewardship - build boat moorings, periodic supervision, socialization and awareness to citizens and visitors, clearing marine debris",
                           `tourism zone`="reallocate and restrict tourism activities",
                           `watershed management and protection`="water catchment management to reduce pollution/sedimentation",
                           `watershed management and protection`="watershed management",
                           # `watershed management`="watershed management and protection",
                           `watershed management and protection`="protection and rehabilitation of coastal vegetation (e.g., through mangrove planting)",
                           `measures to reduce damage caused by anchoring`="reef   protection   markers   (rpms) no-anchoring areas",
                            `land-based pollution and sedimentation management`="implementation  of  coastal  management  strategies  that  reduce  the  impacts  of pollution and increase general environmental quality",
                           `increase the size of no take areas`="increase the size of no take areas\n\nimprove regulation enforcement",
                           `land-based pollution and sedimentation management`="land-based  regulations  on waste  management,  nutrient input and  sedimentation",
                            `manage water quality`="set nutrient level standards and monitor\n\nenforce regulations"))


#list new grouped actions to check if need any further standardising
k1<-data_long$action2 %>% as.character() %>%unique() %>% sort() %>% as.data.frame()


#NEXT IS TO LIST ALL INDICATORS USED FOR EACH MGT INTERVENTION

# df_grouped <- data_long %>%
#   group_by(action2) %>%
#   summarise(indicator_combination = paste(indicators %>% unique(), collapse = " | "),
#             studies = paste(Study.ID.1, collapse = ", "),
#             n_studies = n())


#would need to standaridse the indicator combinations and so the list of indicator_combination is a unique set 

#create a list ordered by action2 and then work on creating standard groups in csv
#this is cleaner and faster than doing it in code as was previous approach


#substitute and, or, ; with , in new column 'indicator_combination_stand' - will save having to do this manually 

data_long %<>%
  mutate(indicator_combination_stand = str_replace_all(indicators, c("&" = ",", ";" = ",")),
         indicator_combination_stand = gsub("([^[:alpha:]])or([^[:alpha:]])", "\\1,\\2", indicator_combination_stand), 
         indicator_combination_stand = gsub("([^[:alpha:]])and([^[:alpha:]])", "\\1,\\2", indicator_combination_stand),
         indicator_combination_stand = gsub(" ,", ",", indicator_combination_stand)) 

#the two alpha lines sub and and or only when they appear as individual words not in the middle of a string e.g. land

data_long[order(data_long$action2),] %>% write.csv("standardise_table_mgt_intervention_indicator_combinations.csv")   


#create the matrix of interventions and related indicators

#read in the file which has manually standardised indicator combinations

g<-read.csv(file = "standardise_table_mgt_intervention_indicator_combinations_revised.csv",header = T)


#have named the new object bleaching_monitoring

bleaching_monitoring<-data_long

#match with g to add the manually standardised indicator combinations to bleaching_monitoring
bleaching_monitoring$ind_comb<-g$indicator_combination_stand2[match(paste(bleaching_monitoring$Study.ID.1,bleaching_monitoring$number),paste(g$Study.ID.1,g$number))]

#had created a list of unique indicators (using steps below) in order to find issues to standardise (listed below) 

#anthropogenic physical impacts (tourism intensity) was not matching when trying to make replacement in bleaching_monitoring due to brackets so added \\ before each bracket to make it work


#make necessary replacements to strings in bleaching_monitoring ind_comb to standardise indicators
bleaching_monitoring %<>% mutate(ind_comb = str_replace_all(ind_comb, 
                                                            c("abundance of coral fishes"='fish abundance',
                                                    "fish populations"='fish abundance',
                                                    "free from fishing pressure"='fishing pressure',
                                                    "total fish abundance"='fish abundance',
                                                    "herbivores biomass"='herbivore fish biomass',
                                                    "herbivore biomass"='herbivore fish biomass',
                                                    "hard coral cover"='coral cover',
                                                    "anthropogenic physical impacts \\(tourism intensity\\)"='anthropogenic physical impacts',
                                                    "evidence of rubble/physical damage"='anthropogenic physical impacts',
                                                    "physical damage from divers"='anthropogenic physical impacts',
                                                    "physical human impacts"='anthropogenic physical impacts',
                                                    "levels of stress"='anthropogenic stress',
                                                    "sensitive to bleaching"='bleaching resistance',
                                                    "coastal development threat"='coastal development',
                                                    "new coastal development"='coastal development',
                                                    "diversity"='coral diversity',
                                                    "diversity of corals"='coral diversity',
                                                    "coral coral"='coral', #to resolve issue with coral coral diversity
                                                    "coral recruitment"='recruitment levels',
                                                    "abundance of  acroporidae  colonies"='acropora cover',
                                                    # "est recovery potential"='recovery potential',
                                                    "recovery"='recovery potential',
                                                    "potential potential"= "potential",
                                                    # "recovery potential"='recovery potential',
                                                    # "est resilience potential"='resilience potential',
                                                    "overall resilience"='resilience potential',
                                                    "relative potential resilience"='resilience potential',
                                                    "relative resilience"='resilience potential',
                                                    "resilience scores"='resilience potential',
                                                    "resilience sites"='resilience potential',
                                                    "resilience"='resilience potential',
                                                    "potential potential"="potential",
                                                    "incidence of disease"='disease prevalence',
                                                    "unsetlable substrate"='unsuitable substrate',
                                                    'threat level'="threat",
                                                    'level of threat'="threat",
                                                    'integrated local threat'="threat",
                                                    "substrate availability"='unsuitable substrate',
                                                    'resistance'="bleaching resistance",
                                                    "bleaching bleaching"="bleaching",
                                                    "free from contamination/pollution"='pollution',
                                                    "nutrient loading"='nutrient input',
                                                    "local currents"='currents',
                                                    "fish species richness"="fish diversity",
                                                    "fish coral"="fish",
                                                    "outside mpa"="mpa",
                                                    "outside NTA"="mpa")))


#this creates the matrix with a list of all the indicator combinations, indicators and studies per intervention
#the str_remove_all line removes the listed terms when creating the list of indicators

df_grouped <- bleaching_monitoring %>%
  group_by(action2) %>%
  summarise(indicator_combination = paste(ind_comb %>% unique(), collapse = " | "),
            studies = paste(Study.ID.1, collapse = ", "),
            n_studies = n(),
   indics = paste(
      unique(
        trimws(
        unlist(
          strsplit(
            str_remove_all(ind_comb,
              "highest|lowest|low|medium|med|very|high|above|below|average|zero|moderate|mod|scores|sites|/|-"
            ), 
            ","
          )
        )
      )), 
      collapse = ", "
    )
    ,
    n_indics2 = length(
      unique(
        trimws(
        unlist(
          strsplit(
            str_remove_all(ind_comb,
              "highest|lowest|low|medium|med|very|high|above|below|average|zero|moderate|mod|scores|sites|/|-" ##remove any mention of low, med, medium, or high

            ), 
            ","
          )
        )
      ))
  )
  )


#reco potential to recovery potential in df_grouped
#dive to dive site
df_grouped %<>% mutate(indics = str_replace_all(indics, 
                                                            c("reco potential"='recovery potential',
                                                              "\\b(dive)\\b"= "dive sites"))
)%>% arrange(desc(n_studies))


#indics and n_indics2 were not final because there could be duplication of indicators listed
#it needed inspection and a further step of manual standardisation

#create a list of unique indicators from df_grouped indics
split_strings <- lapply(df_grouped$indics, function(x) trimws(unlist(strsplit(x, "[,]"))))

characters <- unique(unlist(split_strings))  %>%  sort() %>% as.data.frame() #67 unique indicators

#find issues


                         # replace<-  c(
                         #   `fish abundance`="abundance of coral fishes",
                         #   `fish abundance`="fish populations",
                         #   `fishing pressure`="free from fishing pressure",
                         #   `fish abundance`="total fish abundance",
                         #   `herbivore fish biomass`="herbivores biomass",
                         #   `herbivore fish biomass`="herbivore biomass",
                         #   `hard coral cover`="coral cover",
                         #   `anthropogenic physical impacts`="anthropogenic physical impacts (tourism intensity)",
                         #   `anthropogenic physical impacts`="evidence of rubblephysical damage",
                         #   `anthropogenic physical impacts`="physical damage from divers",
                         #   `anthropogenic physical impacts`="physical human impacts",
                         #   `anthropogenic stress`="levels of stress",
                         #   `bleaching resistance`="sensitive to bleaching",
                         #   `coastal development`="coastal development threat",
                         #   `coastal development`="new coastal development",
                         #   `coral diversity`="diversity",
                         #   `coral diversity`="diversity of corals",
                         #   `coral recruitment`="recruitment levels",
                         #   `acropora cover`="est abundance of acroporidae colonies",
                         #   `recovery potential`="est reco potential",
                         #   `recovery potential`="reco",
                         #   `recovery potential`="reco potential",
                         #   `resilience potential`="est resilience potential",
                         #   `resilience potential`="overall resilience",
                         #   `resilience potential`="relative potential resilience",
                         #   `resilience potential`="relative resilience",
                         #   `resilience potential`="resilience",
                         #   `resilience potential`="resilience scores",
                         #   `resilience potential`="resilience sites",
                         #   `incidence of disease`="disease prevalence",
                         #   `unsuitable substrate`="unsetlable substrate",
                         #   `threat level`="threat",
                         #   `unsuitable substrate`="substrate availability",
                         #   `bleaching resistance`="resistance",
                         #   `pollution`="free from contaminationpollution",
                         #   `nutrient input`="nutrient loading",
                         #   `currents`="local currents")

#Output table
kable(df_grouped, caption = "Indicators used for each management action", 
      row.names = FALSE) %>% 
  kable_styling(full_width = F)

#2. Matrix with actions per indicator

#maybe a more interesting question is about what indicators inform the most different interventions
#- indicators and the list and number of actions they inform
#can also get a full list of indicators used across but not how often/how many assessments used them

#use the characters object so you can go through each indicator one by one and find out the information

#the number of studies each indicator was used  
#to find the total number of times each indicator was used
#using the same approach or adding to the approach I can look for the number of times each indicator is mentioned in bleaching_monitoring$ind_comb

#This fulfills the objective -#3. list of unique indicators and the frequency of use 


output_df <- data.frame(indicator = characters, number_actions = numeric(length(characters)), action = character(length(characters)),number_studies = numeric(length(characters)),indicator_use = numeric(length(characters))) # Initialize the output dataframe
characters2<-characters$.%>%as.vector()

characters3<-characters%>%
  mutate(indicator = str_replace_all(., 
                    c("bioeroding sea urchins"="bio-eroding sea urchins",
                      "free from landbased anthropogenic impacts"="free from land-based anthropogenic impacts",
                      "landbased sources of pollution"="land-based sources of pollution")))%>%
  pull(indicator) %>%
  as.vector()  #create vector instead of dataframe for loop below

df_grouped$action2 %<>% as.character()

#had issues with grepl and mpa for example - finding it in impact. Would making MPA all caps solve the issue? (wont match with ind_comb)
#isses with nta and dive (in diversity)
#land-based

#check to make sure all indicators in character match with  bleaching_monitoring$ind_comb
#these did not match mainly because the - is lost in characters but is in ind_comb in bleaching_monitoring
# bioeroding sea urchins
# free from landbased anthropogenic impacts
# landbased sources of pollution
# pollution (chemical)

#change these manually in characters3 above

#needed to create characters 2 and 3 separately as the changes made abive by adding - meant that some char_pattern was not matching with df_grouped$indics

no_match <- c() # Initialize an empty character vector


for(i in 1:length(characters2)){

  char <- gsub("\\(", "\\\\(", gsub("\\)", "\\\\)", characters2[i]))
  char_ble <- gsub("\\(", "\\\\(", gsub("\\)", "\\\\)", characters3[i]))
  
    if (char=="pollution \\(chemical\\)"|char=="pollution \\(solid\\)"){
char_pattern<-char
char_pattern_ble<-char} else
  {
  char_pattern <- paste("\\b", char, "\\b", sep = "") #modify the grepl function to include word boundaries in the pattern using \\b to match the exact string char as a complete word
  char_pattern_ble <- paste("\\b", char_ble, "\\b", sep = "") #modify the grepl function to include word boundaries in the pattern using \\b to match the exact string char as a complete word
}
  
  matching_rows <- which(grepl(char_pattern, df_grouped$indics)) 
  matching_rows_ind_number<-which(grepl(char_pattern_ble, bleaching_monitoring$ind_comb))
  
  output_df[i, "number_actions"] <- length(matching_rows)
  output_df[i, "indicator_use"] <- length(matching_rows_ind_number)

  if(length(matching_rows) == 0){
    output_df[i, "action"] <- ""
  } else {
    action_string <- paste(df_grouped[matching_rows, "action2"], collapse = ", ")
    action_string <- gsub("\\\\", "", action_string) # remove '\'
    action_string <- gsub("\"", "", action_string) # remove '"'
    action_string <- gsub("c\\(", "", action_string) # remove 'c('
    output_df[i, "action"] <- gsub("\\)", "", action_string) # remove ')
     # <- gsub("^c\\(", "", gsub("\\)$", "", action_string))
    
    output_df[i, "number_studies"] <- bleaching_monitoring[matching_rows_ind_number, "Study.ID.1"] %>% unique() %>%  length()  
    
    #list all those which did not match
   
  }
   if(length(matching_rows_ind_number)==0){
      no_match<-c(no_match, char)
   }
  }

output_df %<>% arrange(desc(number_actions))

#Output table
kable(output_df, caption = "Managment action informed by indicators", 
      row.names = FALSE,
      col.names = c("Indicator","No. of actions","Mgt actions","No. of studies","No. of times indicator used")) %>% 
  kable_styling(full_width = F) 
  

```


What methods were used to prioritise sites for management action?

```{r mgt_methods, eval=TRUE}
data$What.methods.were.used.to.prioritise.sites.for.management.action. %>% unique() #40 options

#need to check that the blanks are not Interpretation of overall/individual indicator results. Check the response to 'Was the assessment used to directly inform management?', should all be either general connection or no connection

data %>% 
filter(What.methods.were.used.to.prioritise.sites.for.management.action. %in% "") %>% 
  # count(inform_mgt) %>%  #there are four assessments with descriptive responses
  filter(inform_mgt %in% "descriptive") %>% 
  distinct(Study.ID.1)#try to list these assessments

# RS_2017_Palau		- Interpretation of overall/individual indicator results		
# FI_2021_Belitung -Interpretation of overall/individual indicator results				
# BC_2018_Comoros	 - Interpretation of resilience and stress scores
# NE_2015_TalimBay -Interpretation of overall/individual indicator results

#change these in management_methods

interpretation<-Cs(NE_2015_TalimBay, FI_2021_Belitung, RS_2017_Palau, DO_2014_Myanmar)

data %<>%
  mutate(What.methods.were.used.to.prioritise.sites.for.management.action. = case_when(Study.ID.1 %in% interpretation~ "Interpretation of overall/individual indicator results",
         Study.ID.1%in%"BC_2018_Comoros"~"Interpretation of resilience and stress scores",
         Study.ID.1%in%"BC_2019_Djibouti"~"Marine Spatial Planning",
         TRUE ~ What.methods.were.used.to.prioritise.sites.for.management.action.))


data %<>%
  mutate(management_methods=What.methods.were.used.to.prioritise.sites.for.management.action. %>% 
                fct_recode(
                          `Interpretation of overall/individual indicator results`="descriptive using individual indicator results",
                          # ``="query/criteria based approach",
                          `query/criteria based approach`="Query based analytical approach",
                          `query/criteria based approach`="query based approach",
                          `Interpretation of overall/individual indicator results`="Using general results from assessment",
                          `Interpretation of overall/individual indicator results`="general recommendations based on overall results",
                          `Interpretation of overall/individual indicator results`="interpreting resilience scores",
                          `Interpretation of overall/individual indicator results`="Interpretation of overall and individual indicator scores",
                          `Interpretation of overall/individual indicator results`="lots of site specific mgt interventions however no structured framework - based on observations across all resilience indicators and total resilience scores through personal interpretation ",
                          `focus on two main resilience factors that were found to influence reefs`="Recommendations for management focus on the two main resilience factors that were found to influence reefs",
                          `Interpretation of overall/individual indicator results`="text descriptions/discussions based on overall resilience",
                          `scenario-based approach`="assessing model outputs (resilience) for different reef types under different scenarios of pressure",
                          `comparing locally manageable resilience factors with other factors`="compares the mean score of locally manageable factors to other factors",
                          `query/criteria based approach`="Query-based: The anthropogenic stress data were then combined with the scores for relative resilience and individual resilience indicators. Criteria were then set to identify management opportunities and reef areas where such actions would support resilience. ",
                          `management influence scores`="used resilience scores combined with scores for management factors that managers can influence ",
                          `Interpretation of overall/individual indicator results`="no specific framework, using general resilience scores",
                          `management influence scores`="Management influence score",
                          `comparison of antrhopogenic stress, management feasibility, recovery, resistance potential`="Using the classifications of the 4 grouping categories, sites were grouped based on what management strategy should be applied at each with regards to protecting and including in an MPA network, and managing local threats. Recovery Potential was considered most important in determining higher ranking for sites. Possible management actions are proposed",
                          `comparison of antrhopogenic stress, management feasibility, recovery, resistance potential`="comparison of level of antrhopogenic stress and local experts assessment of the management feasibility in combination with resilience levels",
                          `Interpretation of resilience and stress scores`="By combining the resilience rankings with current levels of various anthropogenic stressors",
                          `Interpretation of overall/individual indicator results`="general application of model and outputs to inform strategic management",
                          `query/criteria based approach`="query based approach combining the climate projections, local anthropogenic threats, and resilience scores",
                          `Interpretation of overall/individual indicator results`="Descriptive",

                          `Interpretation of overall/individual indicator results`="descriptive based on overall results",
                          `Interpretation of overall/individual indicator results`="interpreting overall resilience scores and individual indicators",
                        
                          `Interpretation of overall/individual indicator results`="Descriptive assessment of individual indicator and overall resilience scores",
                          `comparing locally manageable resilience factors with other factors`="Comparing sites with sedimentation, pollution, and fishing pressure scores vs without",
                          # ``="Not done in this report",
                          `Interpretation of overall/individual indicator results`="general interpretation of data and results",
                          `Interpretation of overall/individual indicator results`="interpretation of various health and resilience indicators",
                          `Interpretation of overall/individual indicator results`="Using overall resilience status/score",
                          `Interpretation of overall/individual indicator results`="Infer from resilience scores and other data",
                          `scenario-based approach`="Modelling responses in resilience under different scenarios of pressure/management",
                          `management influence scores`="Management  influence  potential  rankings  calculated  as  the sum score at each site for the resilience indicators that managers can influence",
                          `management influence scores`="management influence index scores, and specific indicators that scored poorly at sites",
                          `Interpretation of overall/individual indicator results`="text descriptions/discussions",
                          `not done`="None",
                          `intervention effect evaluation`="not done (intervention effect evaluation done instead)",
                          `not done`="Not done in this report")
  )



data_plot<-data %>%  #
  # mutate(management_methods=gsub(na_if,"",management_methods)) %>%   #make blanks into NAs
  # na.omit(management_methods) %>%
  filter( !management_methods %in% "") %>% #remove the NAs
  filter( !management_methods %in% "not done") %>% #remove the NAs
  count(management_methods)  


ggplot(data_plot, aes(x= factor(management_methods), y=n)) +
  geom_bar(stat = "identity",  fill = "#00AFBB") +
  theme_bw()+
  xlab('Method for management prioritisation')+
  ylab('Number of assessments')+
  coord_flip()+
  theme(legend.position = 'none')+
  theme(axis.text.x = element_text())+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```


After all is done, create a matrix with study id, mgt_inform, mgt_interventions (done or not), mgt_factors,  mgt_potential_indicators (number), mgt_indicators (listed or not), mgt_methods - to check for any errors e.g. # MC_2014_Thailand - 15 indicators listed, cabral had a grouping for management indicators. should this be an analytical approach for mgt prioritisation since they calculate a mangement index? check others where a management index/group existed.

```{r mgt_matrix, eval=TRUE}

data$inform_mgt
data$`Were.any.factors.indicators.linked.to.management.actions.`
mgt_interventions$mgt_interventions #which are blank and not blank
mgt_potential_split$number #0, non-zero
data %<>% 
  mutate(`mgt_indicators`=case_when(Study.ID.1 %in% studies~"Yes",
                                     TRUE~'No')) 
data$management_methods

#character vector of column names
mgt_mat_cols<-Cs(Study.ID.1,inform_mgt,indicators.linked.to.management.actions.,mgt_interventions,mgt_potential,mgt_indicators,management_methods)

mgt_matrix<-cbind(data$Study.ID.1 %>% as.character(),
                  data$inform_mgt,
                  data$`Were.any.factors.indicators.linked.to.management.actions.` %>% as.character(),
                  mgt_interventions$mgt_interventions,
                  mgt_potential_split$number%>% as.character(),
                  data$mgt_indicators,
                  data$management_methods%>% as.character()) %>% as.data.frame()

mgt_matrix %<>% rename_at(vars(colnames(mgt_matrix)), function(x) mgt_mat_cols)

#output file as is easier than constantly reproducing

mgt_matrix %>% write.csv("mgt_matrix.csv",row.names = FALSE)

```


#Overall
What type of resilience potential assessment is this?	

```{r assessment_type, eval=TRUE}

data$What.type.of.resilience.potential.assessment.is.this. %>% unique()

# [1] "expert set of (normalised) resilience indicators"                         
# [2] "mechanistic model"                                                        
# [3] "statistical model"                                                        
# [4] "Other: - mechanistic, statistical and simulation modelling"               
# [5] "Other: - predictive modelling (regression model and geostatistical model)"

#NO BLANKS

data %<>%
  mutate(assessment_type=`What.type.of.resilience.potential.assessment.is.this.`   %>% 
                fct_recode(
                          `empirical resilience indicators`="expert set of (normalised) resilience indicators",
                          `multiple model types`= "Other: - mechanistic, statistical and simulation modelling",
                          `multiple model types`= "Other: - predictive modelling (regression model and geostatistical model)"))


  ggplot(data, aes(x= factor(assessment_type))) +
  geom_bar(aes(fill=assessment_type))+
  theme_bw()+
  xlab('Assessment type')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))


```

Type of publication
```{r publication_type, eval=TRUE}
data$Type.of.publication %>% unique()
# "Journal article"          "Other: manuscript"        "Technical report"         "Field report"            
# [5] ""                         "Other: MSc thesis"        "Summary doc (fact sheet)"

#there are some blanks - GG_2009_Pemba - technical report, BC_2018_Comoros - Journal aricle, NE_2015_TalimBay - Journal aricle , DM_2016_EastAfrica - Journal article, MC_2014_Thailand - Other: MSc thesis


data %<>%  mutate(`publication_type`=`Type.of.publication`  %>% 
                    replace(Study.ID.1=="GG_2009_Pemba","Technical report") %>% 
                    replace(Study.ID.1=="BC_2018_Comoros","Journal article") %>% 
                    replace(Study.ID.1=="NE_2015_TalimBay","Journal article") %>% 
                    replace(Study.ID.1=="DM_2016_EastAfrica","Journal article") %>% 
                    replace(Study.ID.1=="MC_2014_Thailand","Other: MSc thesis")) 

data$publication_type %>% unique() #no more blanks

data %<>%
  mutate(publication_type=publication_type   %>% 
                fct_recode(
                          `Manuscript`="Other: manuscript",
                          `MSc thesis`= "Other: MSc thesis",
                          `Summary doc`="Summary doc (fact sheet)"))


  ggplot(data, aes(x= factor(publication_type))) +
  geom_bar(aes(fill=publication_type))+
  theme_bw()+
  xlab('Publication type')+
  ylab('Number of assessments')+
  theme(legend.position = 'none')+
  theme( panel.border = element_blank(),
        axis.text = element_text(size=15),
        axis.line = element_line(colour = "black"),
        text = element_text(size=15))

```

```{r}
library(sf)
library(rnaturalearth)
library(scatterpie)
library(ggnewscale)
library(RColorBrewer)

#create a matrix of number of assessments per region and type of assessment

g<-ftable(data$Region, data$assessment_type) %>% as.data.frame()

g %<>% spread(Var2, Freq)


#download GCRMN coral regions
gcrmn_map <- st_read("GCRMN_regions/gcrmn_regions.shp")


# Download world map with WGS 84/ Equal Earth Greenwich projection
global <- ne_download(scale = 50, type = "countries", returnclass = "sf") %>% st_transform(crs = st_crs(gcrmn_map))

#standardise region names between g and gcrmn_map before matching
gcrmn_map$gcrmn_r %>% unique()
#[1] "Australia"  "Brazil"     "Caribbean"  "EAS"        "ETP"        "Pacific"    "PERSGA"     "ROPME"      "South Asia" "WIO"       

g$Var1 %>% unique()
# [1] Australia              Caribbean              East Asia              ETP                    Pacific               
# [6] Red Sea & Gulf of Aden South Asia             WIO 

gcrmn_map %<>%
  mutate(gcrmn_r = ifelse(gcrmn_r == "EAS", "East Asia",
                          ifelse(gcrmn_r == "PERSGA", "Red Sea & Gulf of Aden", gcrmn_r)))

# world_joined  <- left_join(gcrmn_map, g, by = c('gcrmn_r' = 'Var1'))
data_pie      <- left_join(g, gcrmn_map, by = c('Var1' = 'gcrmn_r'))

#get centroid points for each GCRMN region polygon to locate pie-charts
center<-st_coordinates(st_centroid(gcrmn_map))

centerpoint <- data.frame(region = gcrmn_map$gcrmn_r, lat= center[,1], long = center[,2])

#for labels, add missing rows for ROPME and Brazil
# Create a new data frame with the two rows to add
new_rows <- data.frame(Var1 = c("ROPME", "Brazil"), 
                       `empirical resilience indicators` = rep(0, 2), 
                       `mechanistic model` = rep(0, 2), 
                       `multiple model types` = rep(0, 2), 
                       `statistical model` = rep(0, 2))
                       # lat = rep(0, 2),
                       # long = rep(0, 2),
                       # Num_papers = rep(0, 2))

colnames(new_rows) <- c("Var1", "empirical resilience indicators","mechanistic model","multiple model types","statistical model")

# Add the new rows to the g data frame using bind_rows()
g <- bind_rows(g, new_rows)

#assign coordinates to g
g$lat<-centerpoint$lat[match(g$Var1,centerpoint$region)]
g$long<-centerpoint$long[match(g$Var1,centerpoint$region)]

g[is.na(g)]=0

g$Num_papers<-rowSums(g[2:5]) #total number of papers in each region

g[g$Var1 == "Pacific", "lat"] <- -13054316.0 #change lat of Pacific for label

#set lat and long for label positions
g$label_lat<-g$lat
g$label_long<-g$long-1000000

g[g$Var1 == "ROPME", "label_long"] <- g$long[g$Var1 == "ROPME"]+500000 #change lat of Pacific for label
g[g$Var1 == "Caribbean", "label_long"] <- g$long[g$Var1 == "Caribbean"]+1000000 #change lat of Pacific for label
g[g$Var1 == "WIO", "label_long"] <- g$long[g$Var1 == "WIO"]+1000000 #change lat of Pacific for label


gcrmn_map$Num_papers<-g$Num_papers[match(gcrmn_map$gcrmn_r,g$Var1)] #add total papers to gcrmn_map
gcrmn_map[is.na(gcrmn_map)]=0

theme_bluewhite <- function (base_size = 11, base_family = "") {
  theme_bw() %+replace% 
    theme(
      panel.grid.major  = element_line(color = "white"),
      panel.background = element_rect(fill = "lightblue"),
      panel.border = element_rect(color = "lightblue", fill = NA),
      axis.line = element_line(color = "lightblue"),
      axis.ticks = element_line(color = "lightblue"),
      axis.text = element_text(color = "steelblue"),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}



ggplot() + 
  #1. basic map layer
  coord_fixed()+
  geom_sf(data = gcrmn_map, aes(geometry = geometry, group=gcrmn_r, fill = Num_papers),colour='black', lwd=1)+ #color layer for nb of papers in each country
  geom_sf(data= global, fill='white')+
  theme_bluewhite()+
  geom_label(data = g, aes(label = Var1, x=label_lat, y=label_long), 
             size = 3, color = "black", fontface = "bold")+
  #color for the bar
  scale_fill_gradient(name = "Number of assessments", 
                      breaks = c(5, 10, 15, 21),
                      labels = c("5", "10", "15", "21"),
                      low = brewer.pal(9, "YlGnBu")[1],   # lightest color in palette
                      high = brewer.pal(9, "YlGnBu")[9])+
  new_scale('fill')+
  # 3. pie chart layer
   geom_scatterpie(data = g, aes(x=lat, y=long, group = Var1),
                   cols =c("empirical resilience indicators","mechanistic model","multiple model types","statistical model")) +
    scale_fill_manual(values = c("#009E73", "#E69F00", "#56B4E9","red"), 
                   labels = c("empirical resilience indicators","mechanistic model","multiple model types","statistical model")) +
  labs(xlab="",ylab="",title=('Global view of resilience potential assessments'))+
  labs(fill = "Assessment type")+
  coord_sf(datum = NA) 

ggsave("resilience_map.jpg", plot = last_plot(), width = 10, height = 7, dpi = 300)



```


```{r gcrmn_pacific}
library(sf)
library(rnaturalearth)
library(scatterpie)
library(ggnewscale)
library(RColorBrewer)

#create a matrix of number of assessments per region and type of assessment

g<-ftable(data$Region, data$assessment_type) %>% as.data.frame()

g %<>% spread(Var2, Freq)

# Centered in lon 130 on this example

# offset <- 180 - 60  #pacific
offset <- 180 - 155 #atlantic

polygon <- st_polygon(x = list(rbind(
  c(-0.0001 - offset, 90),
  c(0 - offset, 90),
  c(0 - offset, -90),
  c(-0.0001 - offset, -90),
  c(-0.0001 - offset, 90)
))) %>%
  st_sfc() %>%
  st_set_crs(8857)


#download GCRMN coral regions
gcrmn_map <- st_read("GCRMN_regions/gcrmn_regions.shp")

# new_crs <- st_crs("+proj=eqc +lat_0=0 +lon_0=60 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs") #start at 120 West in Pacific

new_crs<- st_crs("+proj=eqc +lat_0=0 +lon_0=155 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs") #Atlantic


gcrmn_map <- gcrmn_map %>% st_difference(polygon)

gcrmn_map <- st_transform(gcrmn_map, new_crs)  


# Download world map with WGS 84/ Equal Earth Greenwich projection
global <- ne_download(scale = 50, type = "countries", returnclass = "sf") %>% 
  filter(SOVEREIGNT != "Antarctica")


polygon <- st_polygon(x = list(rbind(
  c(-0.0001 - offset, 90),
  c(0 - offset, 90),
  c(0 - offset, -90),
  c(-0.0001 - offset, -90),
  c(-0.0001 - offset, 90)
))) %>%
  st_sfc() %>%
  st_set_crs(4326)

# Remove slim polygon
global <- global %>% st_difference(polygon)

global<- global %>% st_transform(crs = st_crs(new_crs))

#standardise region names between g and gcrmn_map before matching
gcrmn_map$gcrmn_r %>% unique()
#[1] "Australia"  "Brazil"     "Caribbean"  "EAS"        "ETP"        "Pacific"    "PERSGA"     "ROPME"      "South Asia" "WIO"       

g$Var1 %>% unique()
# [1] Australia              Caribbean              East Asia              ETP                    Pacific               
# [6] Red Sea & Gulf of Aden South Asia             WIO 

gcrmn_map %<>%
  mutate(gcrmn_r = ifelse(gcrmn_r == "EAS", "East Asia",
                          ifelse(gcrmn_r == "PERSGA", "Red Sea & Gulf of Aden",
                          ifelse(gcrmn_r == "ROPME", "Arabian Gulf",
                                 gcrmn_r))))

# world_joined  <- left_join(gcrmn_map, g, by = c('gcrmn_r' = 'Var1'))
data_pie      <- left_join(g, gcrmn_map, by = c('Var1' = 'gcrmn_r'))

#get centroid points for each GCRMN region polygon to locate pie-charts
center<-st_coordinates(st_centroid(gcrmn_map))

centerpoint <- data.frame(region = gcrmn_map$gcrmn_r, lat= center[,1], long = center[,2])

#for labels, add missing rows for ROPME (Arabian Gulf) and Brazil
# Create a new data frame with the two rows to add
new_rows <- data.frame(Var1 = c("Arabian Gulf", "Brazil"), 
                       `empirical resilience indicators` = rep(0, 2), 
                       `mechanistic model` = rep(0, 2), 
                       `multiple model types` = rep(0, 2), 
                       `statistical model` = rep(0, 2))
                       # lat = rep(0, 2),
                       # long = rep(0, 2),
                       # Num_papers = rep(0, 2))

colnames(new_rows) <- c("Var1", "empirical resilience indicators","mechanistic model","multiple model types","statistical model")

# Add the new rows to the g data frame using bind_rows()
g <- bind_rows(g, new_rows)

#assign coordinates to g
g$lat<-centerpoint$lat[match(g$Var1,centerpoint$region)]
g$long<-centerpoint$long[match(g$Var1,centerpoint$region)]

g[is.na(g)]=0

g$Num_papers<-rowSums(g[2:5]) #total number of papers in each region

# g[g$Var1 == "Pacific", "lat"] <- -13054316.0 #change lat of Pacific for label

#set lat and long for label positions
g$label_lat<-g$lat
g$label_long<-g$long-1000000

g[g$Var1 == "Arabian Gulf", "label_long"] <- g$long[g$Var1 == "Arabian Gulf"]+500000 #change lat of Pacific for label
g[g$Var1 == "Caribbean", "label_long"] <- g$long[g$Var1 == "Caribbean"]+1000000 #change lat of Pacific for label
g[g$Var1 == "WIO", "label_long"] <- g$long[g$Var1 == "WIO"]+1000000 #change lat of Pacific for label


gcrmn_map$Num_papers<-g$Num_papers[match(gcrmn_map$gcrmn_r,g$Var1)] #add total papers to gcrmn_map
gcrmn_map[is.na(gcrmn_map)]=0

theme_bluewhite <- function (base_size = 11, base_family = "") {
  theme_bw() %+replace% 
    theme(
      panel.grid.major  = element_line(color = "white"),
      panel.background = element_rect(fill = "lightblue"),
      panel.border = element_rect(color = "lightblue", fill = NA),
      axis.line = element_line(color = "lightblue"),
      axis.ticks = element_line(color = "lightblue"),
      axis.text = element_text(color = "steelblue"),
      axis.title.x = element_blank(),
      axis.title.y = element_blank()
    )
}



ggplot() + 
  #1. basic map layer
  coord_fixed()+
  geom_sf(data = gcrmn_map, aes(geometry = geometry, group=gcrmn_r, fill = Num_papers),colour='black', lwd=1)+ #color layer for nb of papers in each country
  geom_sf(data= global, fill='bisque')+
  theme_bluewhite()+
  geom_label(data = g, aes(label = Var1, x=label_lat, y=label_long), 
             size = 3, color = "black", fontface = "bold")+
  #color for the bar
  scale_fill_gradient(name = "Number of assessments", 
                      breaks = c(0,5, 10, 15, 21),
                      labels = c("0","5", "10", "15", "21"),
                      low = "white",   # lightest color in palette
                      high = brewer.pal(9, "YlGnBu")[9])+
  new_scale('fill')+
  # 3. pie chart layer
   geom_scatterpie(data = g, aes(x=lat, y=long, group = Var1),
                   cols =c("empirical resilience indicators","mechanistic model","multiple model types","statistical model")) +
    scale_fill_manual(values = c("#009E73", "#E69F00", "#56B4E9","red"), 
                   labels = c("empirical resilience indicators","mechanistic model","multiple model types","statistical model")) +
  labs(xlab="",ylab="")+
  labs(fill = "Assessment type")+
  theme(legend.text = element_text(size=14),
        legend.title = element_text(size=14, face="bold"),
        plot.margin = margin(0, 0, 0, 0))+
  coord_sf(datum = NA) 

ggsave("resilience_map_gcrmn.jpg", plot = last_plot(), width = 15.92, height=6.8,dpi=400)



```
